<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Maker Pro Ver 24.0</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <style>
        body { font-family: sans-serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .sticky-col { position: sticky; left: 0; background: white; z-index: 10; border-right: 2px solid #e2e8f0; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- SVGアイコン ---
        const Icon = ({ name, size = 16, className = "" }) => {
            const paths = {
                Calendar: <g><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></g>,
                Users: <g><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></g>,
                Settings: <g><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></g>,
                CheckCircle: <g><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></g>,
                Trash2: <g><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></g>,
                RefreshCw: <g><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></g>,
                User: <g><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></g>,
                Star: <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>,
                Download: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></g>,
                Truck: <g><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></g>,
                Flag: <g><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></g>,
                LogIn: <g><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></g>,
                FileSpreadsheet: <g><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="16" y2="17"/></g>,
                Upload: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></g>,
                Briefcase: <g><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></g>
            };
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {paths[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        // --- 定数 ---
        const ROLES = {
            MANAGER: { id: 'manager', label: '店長', color: 'bg-purple-100 text-purple-800', hexBg: '#f3e8ff', hexText: '#6b21a8', icon: 'Star' },
            VICE_MANAGER: { id: 'vice_manager', label: '副店長', color: 'bg-purple-50 text-purple-700', hexBg: '#faf5ff', hexText: '#7e22ce', icon: 'Star' },
            CREW: { id: 'crew', label: 'クルー', color: 'bg-blue-100 text-blue-800', hexBg: '#dbeafe', hexText: '#1e40af', icon: 'User' },
            PART_TIME: { id: 'part_time', label: 'バイト', color: 'bg-green-100 text-green-800', hexBg: '#dcfce7', hexText: '#166534', icon: 'User' },
            DISPATCH: { id: 'dispatch', label: '派遣', color: 'bg-orange-100 text-orange-800', hexBg: '#ffedd5', hexText: '#9a3412', icon: 'Briefcase' },
            HELP_GUEST: { id: 'help_guest', label: 'ヘルプ(受入)', color: 'bg-teal-100 text-teal-800', hexBg: '#ccfbf1', hexText: '#115e59', icon: 'LogIn' },
            EVENT: { id: 'event', label: 'イベント専属', color: 'bg-red-100 text-red-800', hexBg: '#fee2e2', hexText: '#991b1b', icon: 'Star' },
        };

        const WEEKDAYS = ['日', '月', '火', '水', '木', '金', '土'];
        const HOLIDAYS_2025 = ['2025-01-01', '2025-01-13', '2025-02-11', '2025-02-23', '2025-02-24', '2025-03-20', '2025-04-29', '2025-05-03', '2025-05-04', '2025-05-05', '2025-05-06', '2025-07-21', '2025-08-11', '2025-09-15', '2025-09-23', '2025-10-13', '2025-11-03', '2025-11-23', '2025-11-24'];
        const FIXED_OFF_DAYS = 10; 
        const MAX_CONSECUTIVE_WORK = 5; 
        const STORAGE_KEY = 'shift_maker_pro_v24_full';

        // --- 子コンポーネント ---
        const TabButton = ({ id, label, icon, isActive, onClick }) => (
            <button
                onClick={() => onClick(id)}
                className={`flex items-center gap-2 px-4 py-3 border-b-2 text-sm whitespace-nowrap transition-all ${
                isActive ? 'border-blue-600 text-blue-600 bg-blue-50 font-bold' : 'border-transparent text-gray-500 hover:text-gray-700'
                }`}
            >
                <Icon name={icon} size={16} />{label}
            </button>
        );

        // --- メインアプリ ---
        function App() {
            const [activeTab, setActiveTab] = useState('settings');
            const [storeName, setStoreName] = useState('');
            const [year, setYear] = useState(2025);
            const [month, setMonth] = useState(5);
            const [reqWeekday, setReqWeekday] = useState(2);
            const [reqWeekend, setReqWeekend] = useState(3);
            const [reqEvent, setReqEvent] = useState(4);
            const [shiftMode, setShiftMode] = useState('complex');
            const [closedWeekDays, setClosedWeekDays] = useState([]); 
            const [specificClosedDays, setSpecificClosedDays] = useState([]); 
            const [staffList, setStaffList] = useState([
                { id: 1, name: '佐藤一郎', role: 'manager' },
                { id: 2, name: '鈴木花子', role: 'vice_manager' },
                { id: 3, name: '田中次郎', role: 'crew' },
                { id: 4, name: '高橋美咲', role: 'part_time' },
                { id: 5, name: 'イベント担当', role: 'event' },
                { id: 99, name: '新宿店よりヘルプ', role: 'help_guest' },
            ]);
            const [newStaffName, setNewStaffName] = useState('');
            const [newStaffRole, setNewStaffRole] = useState('crew');
            const [helpStores, setHelpStores] = useState([]); 
            const [newHelpStore, setNewHelpStore] = useState('');
            
            // イベント設定
            const [storeEventTypes, setStoreEventTypes] = useState([{ id: 'sevt_default', name: 'イベント', color: 'bg-red-500 text-white', hexBg:'#ef4444', hexText:'#ffffff' }]);
            const [newStoreEventName, setNewStoreEventName] = useState('');
            const [staffEventTypes, setStaffEventTypes] = useState([
                { id: 'se_1', name: '会議', color: 'bg-indigo-200 text-indigo-800', hexBg: '#c7d2fe', hexText: '#3730a3' },
                { id: 'se_2', name: '巡回', color: 'bg-emerald-200 text-emerald-800', hexBg: '#a7f3d0', hexText: '#065f46' },
            ]);
            const [newStaffEventName, setNewStaffEventName] = useState('');
            
            const [dailyStoreEvents, setDailyStoreEvents] = useState({});
            const [requests, setRequests] = useState({});
            const [helpAssignments, setHelpAssignments] = useState({});
            const [schedule, setSchedule] = useState(null);
            const [generationLog, setGenerationLog] = useState([]);

            // データの自動保存
            useEffect(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    try { 
                        const p = JSON.parse(saved);
                        if (p.storeName !== undefined) setStoreName(p.storeName);
                        if (p.year) setYear(p.year); if (p.month) setMonth(p.month);
                        if (p.reqWeekday) setReqWeekday(p.reqWeekday); if (p.reqWeekend) setReqWeekend(p.reqWeekend); if (p.reqEvent) setReqEvent(p.reqEvent);
                        if (p.shiftMode) setShiftMode(p.shiftMode);
                        if (p.closedWeekDays) setClosedWeekDays(p.closedWeekDays);
                        if (p.specificClosedDays) setSpecificClosedDays(p.specificClosedDays);
                        if (p.staffList) setStaffList(p.staffList);
                        if (p.helpStores) setHelpStores(p.helpStores);
                        if (p.storeEventTypes) setStoreEventTypes(p.storeEventTypes);
                        if (p.staffEventTypes) setStaffEventTypes(p.staffEventTypes);
                        if (p.dailyStoreEvents) setDailyStoreEvents(p.dailyStoreEvents);
                        if (p.requests) setRequests(p.requests);
                        if (p.helpAssignments) setHelpAssignments(p.helpAssignments);
                    } catch (e) { console.error(e); }
                }
            }, []);

            const getExportData = () => ({ storeName, year, month, reqWeekday, reqWeekend, reqEvent, shiftMode, closedWeekDays, specificClosedDays, staffList, helpStores, storeEventTypes, staffEventTypes, dailyStoreEvents, requests, helpAssignments });
            const saveToLocal = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(getExportData()));

            // 日付ヘルパー
            const daysInMonth = new Date(year, month, 0).getDate();
            const dateList = Array.from({ length: daysInMonth }, (_, i) => i + 1);
            const getDateKey = (d) => `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const getWeekDayIndex = (d) => new Date(year, month - 1, d).getDay();
            const getWeekDay = (d) => WEEKDAYS[getWeekDayIndex(d)];
            const isWeekend = (d) => [0, 6].includes(getWeekDayIndex(d));
            const isHoliday = (d) => HOLIDAYS_2025.includes(getDateKey(d));
            const isClosed = (d) => specificClosedDays.includes(getDateKey(d)) || closedWeekDays.includes(getWeekDayIndex(d));
            const isEventDay = (d) => !!dailyStoreEvents[getDateKey(d)];
            const getRequiredNum = (d) => isEventDay(d) ? reqEvent : (isWeekend(d) || isHoliday(d) ? reqWeekend : reqWeekday);

            // 操作系
            const addStaff = () => { if (newStaffName) { setStaffList([...staffList, { id: Date.now(), name: newStaffName, role: newStaffRole }]); setNewStaffName(''); }};
            const addHelpStore = () => { if (newHelpStore && !helpStores.includes(newHelpStore)) { setHelpStores([...helpStores, newHelpStore]); setNewHelpStore(''); }};
            const addStoreEvent = () => { if (newStoreEventName) { setStoreEventTypes([...storeEventTypes, { id: `sevt_${Date.now()}`, name: newStoreEventName, color: 'bg-red-500 text-white' }]); setNewStoreEventName(''); }};
            const addStaffEvent = () => { if (newStaffEventName) { setStaffEventTypes([...staffEventTypes, { id: `stevt_${Date.now()}`, name: newStaffEventName, color: 'bg-indigo-200 text-indigo-800' }]); setNewStaffEventName(''); }};

            const toggleClosedWeekDay = (i) => {
                setClosedWeekDays(closedWeekDays.includes(i) ? closedWeekDays.filter(x => x !== i) : [...closedWeekDays, i]);
            };
            const toggleSpecificClosedDay = (d) => {
                const k = getDateKey(d);
                setSpecificClosedDays(specificClosedDays.includes(k) ? specificClosedDays.filter(x => x !== k) : [...specificClosedDays, k]);
            };

            const toggleDailyStoreEvent = (d) => {
                const key = getDateKey(d);
                if (!dailyStoreEvents[key]) setDailyStoreEvents({ ...dailyStoreEvents, [key]: storeEventTypes[0].id });
                else {
                    const idx = storeEventTypes.findIndex(e => e.id === dailyStoreEvents[key]);
                    if (idx < storeEventTypes.length - 1) setDailyStoreEvents({ ...dailyStoreEvents, [key]: storeEventTypes[idx+1].id });
                    else { const next = { ...dailyStoreEvents }; delete next[key]; setDailyStoreEvents(next); }
                }
            };

            const handleRequestChange = (staffId, d, role) => {
                const key = `${staffId}_${getDateKey(d)}`;
                const cur = requests[key];
                if (role === 'help_guest' || role === 'event') {
                    const mark = role === 'event' ? 'event_in' : 'guest_in';
                    setRequests({ ...requests, [key]: cur === mark ? undefined : mark });
                } else {
                    if (!cur) setRequests({ ...requests, [key]: 'off' });
                    else if (cur === 'off') setRequests({ ...requests, [key]: 'paid' });
                    else {
                        const idx = staffEventTypes.findIndex(e => e.id === cur);
                        if (idx < staffEventTypes.length - 1) setRequests({ ...requests, [key]: staffEventTypes[idx+1].id });
                        else { const next = { ...requests }; delete next[key]; setRequests(next); }
                    }
                }
            };

            const handleHelpAssign = (staffId, d, store) => {
                const key = `${staffId}_${getDateKey(d)}`;
                if (!store) { const next = { ...helpAssignments }; delete next[key]; setHelpAssignments(next); }
                else setHelpAssignments({ ...helpAssignments, [key]: store });
            };

            // シフト生成ロジック (ご提示いただいた高度なチケット制 & 責任者優先 & 5連勤制限)
            const generateShift = () => {
                let newSchedule = {};
                let logs = [];
                const hasResponsible = staffList.some(s => ['manager', 'vice_manager'].includes(s.role));
                const staffStats = staffList.map(s => {
                    const isFullTime = !['help_guest', 'event'].includes(s.role);
                    return { ...s, isFullTime, tokens: isFullTime ? daysInMonth - FIXED_OFF_DAYS : 0, offCount: 0, consecutiveWork: 0 };
                });

                // 1. 固定・休みの反映
                for (let d = 1; d <= daysInMonth; d++) {
                    const dateKey = getDateKey(d);
                    const dayClosed = isClosed(d);
                    staffStats.forEach(s => {
                        const key = `${s.id}_${dateKey}`;
                        const req = requests[key];
                        const help = helpAssignments[key];

                        if (dayClosed) { newSchedule[key] = '定休'; s.offCount++; }
                        else if (help) { newSchedule[key] = help; s.tokens--; }
                        else if (req === 'off') { newSchedule[key] = '希望'; s.offCount++; s.tokens--; }
                        else if (req === 'paid') { newSchedule[key] = '有給'; s.offCount++; s.tokens--; }
                        else if (staffEventTypes.some(e => e.id === req)) {
                            newSchedule[key] = staffEventTypes.find(e => e.id === req).name;
                            s.tokens--;
                        }
                        else if (!s.isFullTime) {
                            const mark = s.role === 'event' ? 'event_in' : 'guest_in';
                            if (req !== mark) { newSchedule[key] = '-'; s.offCount++; }
                        }
                    });
                }

                // 2. 日ごとの割り当て
                for (let d = 1; d <= daysInMonth; d++) {
                    const dateKey = getDateKey(d);
                    if (isClosed(d)) { staffStats.forEach(s => s.consecutiveWork = 0); continue; }
                    
                    const targetNum = getRequiredNum(d);
                    let assigned = staffStats.filter(s => !s.isFullTime && !newSchedule[`${s.id}_${dateKey}`]);
                    let candidates = staffStats.filter(s => !newSchedule[`${s.id}_${dateKey}`] && s.isFullTime);

                    // 連勤制限
                    candidates = candidates.filter(s => {
                        if (s.consecutiveWork >= MAX_CONSECUTIVE_WORK) {
                            newSchedule[`${s.id}_${dateKey}`] = '公休'; s.offCount++; s.consecutiveWork = 0; return false;
                        }
                        return true;
                    });

                    // 責任者確保
                    if (!assigned.some(s => ['manager', 'vice_manager'].includes(s.role)) && hasResponsible) {
                        let mgrs = candidates.filter(s => ['manager', 'vice_manager'].includes(s.role));
                        if (mgrs.length > 0) {
                            mgrs.sort((a, b) => b.tokens - a.tokens + (Math.random() - 0.5));
                            const picked = mgrs[0];
                            assigned.push(picked);
                            candidates = candidates.filter(c => c.id !== picked.id);
                        }
                    }

                    // 残り枠を埋める
                    candidates.sort((a, b) => b.tokens - a.tokens + (Math.random() - 0.5));
                    while (assigned.length < targetNum && candidates.length > 0) {
                        assigned.push(candidates.shift());
                    }

                    // 確定
                    assigned.forEach((s, idx) => {
                        const k = `${s.id}_${dateKey}`;
                        if (!newSchedule[k]) {
                            newSchedule[k] = shiftMode === 'complex' ? (idx % 2 === 0 ? '早' : '遅') : 'フル';
                            s.tokens--; s.consecutiveWork++;
                        }
                    });
                    
                    // 選ばれなかったフルタイムは公休
                    staffStats.forEach(s => {
                        if (!newSchedule[`${s.id}_${dateKey}`]) { newSchedule[`${s.id}_${dateKey}`] = '公休'; s.offCount++; s.consecutiveWork = 0; }
                    });
                }
                setSchedule(newSchedule); setActiveTab('result'); saveToLocal();
            };

            const handleExcelExport = () => {
                if (!schedule) return;
                let html = `<table border="1"><thead><tr><th>名前</th><th>役職</th>`;
                dateList.forEach(d => html += `<th>${d}</th>`);
                html += `<th>休日計</th></tr></thead><tbody>`;
                staffList.forEach(s => {
                    let offCount = 0;
                    html += `<tr><td>${s.name}</td><td>${ROLES[s.role.toUpperCase()]?.label}</td>`;
                    dateList.forEach(d => {
                        const v = schedule[`${s.id}_${getDateKey(d)}`] || '';
                        html += `<td>${v}</td>`;
                        if (['公休','希望','有給','定休'].includes(v)) offCount++;
                    });
                    html += `<td>${offCount}</td></tr>`;
                });
                html += `</tbody></table>`;
                const link = document.createElement('a');
                link.href = URL.createObjectURL(new Blob([html], { type: 'application/vnd.ms-excel' }));
                link.download = `shift_${year}_${month}.xls`;
                link.click();
            };

            return (
                <div className="max-w-6xl mx-auto md:my-6 bg-white shadow-2xl rounded-2xl overflow-hidden min-h-[800px]">
                    {/* Header */}
                    <div className="bg-slate-800 p-5 text-white flex justify-between items-center">
                        <div>
                            <h1 className="text-xl font-bold flex items-center gap-2"><Icon name="RefreshCw" className="text-blue-400"/> Shift Maker Pro Ver 24.0</h1>
                            <p className="text-slate-400 text-xs mt-1">{storeName || '店舗名未設定'} | {year}年{month}月</p>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => { saveToLocal(); alert('ブラウザに保存しました'); }} className="bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded text-xs flex items-center gap-2"><Icon name="Download"/> 保存</button>
                            <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="bg-red-900/50 hover:bg-red-900 px-3 py-2 rounded text-xs">初期化</button>
                        </div>
                    </div>

                    {/* Navigation */}
                    <div className="flex border-b overflow-x-auto bg-white sticky top-0 z-20 shadow-sm">
                        <TabButton id="settings" label="基本設定" icon="Settings" isActive={activeTab === 'settings'} onClick={setActiveTab} />
                        <TabButton id="staff" label="スタッフ" icon="Users" isActive={activeTab === 'staff'} onClick={setActiveTab} />
                        <TabButton id="help" label="他店ヘルプ" icon="Truck" isActive={activeTab === 'help'} onClick={setActiveTab} />
                        <TabButton id="conditions" label="予定・希望休" icon="Calendar" isActive={activeTab === 'conditions'} onClick={setActiveTab} />
                        <TabButton id="result" label="シフト表" icon="CheckCircle" isActive={activeTab === 'result'} onClick={setActiveTab} />
                    </div>

                    <div className="p-6">
                        {/* 1. Settings */}
                        {activeTab === 'settings' && (
                            <div className="grid md:grid-cols-2 gap-8 animate-fadeIn">
                                <div className="space-y-6">
                                    <div className="bg-slate-50 p-5 rounded-xl border">
                                        <h3 className="font-bold mb-4 flex items-center gap-2"><Icon name="Settings" className="text-blue-600"/> 基本設定</h3>
                                        <div className="space-y-4">
                                            <div><label className="text-xs font-bold text-slate-500">店舗名</label><input type="text" value={storeName} onChange={e => setStoreName(e.target.value)} className="w-full border p-2 rounded mt-1 outline-none"/></div>
                                            <div className="flex gap-4">
                                                <div className="flex-1"><label className="text-xs font-bold text-slate-500">年</label><input type="number" value={year} onChange={e => setYear(Number(e.target.value))} className="w-full border p-2 rounded mt-1"/></div>
                                                <div className="flex-1"><label className="text-xs font-bold text-slate-500">月</label><select value={month} onChange={e => setMonth(Number(e.target.value))} className="w-full border p-2 rounded mt-1">{[...Array(12)].map((_, i) => <option key={i+1} value={i+1}>{i+1}月</option>)}</select></div>
                                            </div>
                                            <div className="grid grid-cols-3 gap-2">
                                                <div className="text-center"><label className="text-[10px] font-bold">平日数</label><input type="number" value={reqWeekday} onChange={e => setReqWeekday(Number(e.target.value))} className="w-full border p-2 rounded mt-1 text-center"/></div>
                                                <div className="text-center"><label className="text-[10px] font-bold text-orange-600">土日数</label><input type="number" value={reqWeekend} onChange={e => setReqWeekend(Number(e.target.value))} className="w-full border p-2 rounded mt-1 text-center"/></div>
                                                <div className="text-center"><label className="text-[10px] font-bold text-red-600">イベント</label><input type="number" value={reqEvent} onChange={e => setReqEvent(Number(e.target.value))} className="w-full border p-2 rounded mt-1 text-center"/></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-red-50 p-5 rounded-xl border border-red-100">
                                        <h3 className="font-bold text-red-800 mb-3 text-sm">曜日定休設定</h3>
                                        <div className="flex gap-2 justify-between">
                                            {WEEKDAYS.map((w, i) => (
                                                <button key={i} onClick={() => toggleClosedWeekDay(i)} className={`w-10 h-10 rounded-full font-bold text-xs border transition-all ${closedWeekDays.includes(i) ? 'bg-red-500 text-white shadow-lg' : 'bg-white text-slate-400'}`}>{w}</button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-white p-5 rounded-xl border shadow-inner">
                                    <h3 className="font-bold text-slate-700 mb-4 text-sm flex justify-between items-center">特定日の定休設定 <span className="text-[10px] font-normal text-slate-400">日付クリックで切替</span></h3>
                                    <div className="grid grid-cols-7 gap-1">
                                        {WEEKDAYS.map(w => <div key={w} className="text-center text-[10px] font-bold py-2 bg-slate-100">{w}</div>)}
                                        {dateList.map(d => (
                                            <button key={d} onClick={() => toggleSpecificClosedDay(d)} className={`h-12 text-sm border rounded-lg transition-all ${isClosed(d) ? 'bg-red-500 text-white font-bold' : 'bg-white hover:bg-red-50'}`}>{d}</button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 2. Staff */}
                        {activeTab === 'staff' && (
                            <div className="space-y-6 animate-fadeIn">
                                <div className="bg-slate-800 p-5 rounded-xl flex flex-wrap gap-4 items-end">
                                    <div className="flex-1 min-w-[200px]"><label className="text-xs text-slate-400">スタッフ氏名</label><input type="text" value={newStaffName} onChange={e => setNewStaffName(e.target.value)} className="w-full bg-slate-700 text-white p-3 rounded mt-1 border-none focus:ring-2 focus:ring-blue-500" placeholder="名前を入力"/></div>
                                    <div className="w-48"><label className="text-xs text-slate-400">役職</label><select value={newStaffRole} onChange={e => setNewStaffRole(e.target.value)} className="w-full bg-slate-700 text-white p-3 rounded mt-1">{Object.values(ROLES).map(r => <option key={r.id} value={r.id}>{r.label}</option>)}</select></div>
                                    <button onClick={addStaff} className="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold">追加</button>
                                </div>
                                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {staffList.map(s => {
                                        const r = ROLES[s.role.toUpperCase()] || ROLES.CREW;
                                        return (
                                            <div key={s.id} className="flex items-center justify-between p-4 bg-white border rounded-xl shadow-sm">
                                                <div className="flex items-center gap-3">
                                                    <div className={`p-2 rounded-full ${r.color}`}><Icon name={r.icon} size={20}/></div>
                                                    <div><p className="font-bold">{s.name}</p><p className="text-[10px] text-slate-400 tracking-widest">{r.label}</p></div>
                                                </div>
                                                <button onClick={() => setStaffList(staffList.filter(x => x.id !== s.id))} className="text-slate-300 hover:text-red-500 transition-colors"><Icon name="Trash2" size={18}/></button>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* 3. Help */}
                        {activeTab === 'help' && (
                            <div className="space-y-6 animate-fadeIn">
                                <div className="bg-yellow-50 p-5 rounded-xl border border-yellow-200">
                                    <h3 className="font-bold text-yellow-800 mb-3 text-sm">派遣先店舗登録</h3>
                                    <div className="flex gap-2">
                                        <input type="text" value={newHelpStore} onChange={e => setNewHelpStore(e.target.value)} className="border p-3 rounded flex-1" placeholder="店舗名 (例: 渋谷店)"/>
                                        <button onClick={addHelpStore} className="bg-yellow-600 text-white px-6 rounded-lg font-bold">登録</button>
                                    </div>
                                    <div className="flex gap-2 mt-3 flex-wrap">
                                        {helpStores.map(h => <span key={h} className="bg-white border-yellow-300 border text-yellow-800 px-3 py-1 rounded-full text-xs flex items-center gap-2">{h} <button onClick={() => setHelpStores(helpStores.filter(x => x !== h))} className="text-red-400">×</button></span>)}
                                    </div>
                                </div>
                                <div className="overflow-x-auto rounded-xl border">
                                    <table className="w-full text-[11px] border-collapse">
                                        <thead className="bg-slate-100">
                                            <tr><th className="p-3 border-r w-32 sticky left-0 bg-slate-100">スタッフ</th>{dateList.map(d => <th key={d} className="p-2 border-r text-center">{d}</th>)}</tr>
                                        </thead>
                                        <tbody>
                                            {staffList.filter(s => !['help_guest', 'event'].includes(s.role)).map(s => (
                                                <tr key={s.id} className="border-t">
                                                    <td className="p-3 border-r font-bold sticky left-0 bg-white">{s.name}</td>
                                                    {dateList.map(d => (
                                                        <td key={d} className="border-r p-0 h-10">
                                                            <select value={helpAssignments[`${s.id}_${getDateKey(d)}`] || ''} onChange={e => handleHelpAssign(s.id, d, e.target.value)} className="w-full h-full text-center text-[10px] bg-transparent outline-none border-none">
                                                                <option value="">-</option>
                                                                {helpStores.map(h => <option key={h} value={h}>{h}</option>)}
                                                            </select>
                                                        </td>
                                                    ))}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* 4. Conditions */}
                        {activeTab === 'conditions' && (
                            <div className="space-y-6 animate-fadeIn">
                                <div className="grid md:grid-cols-2 gap-4">
                                    <div className="bg-slate-100 p-4 rounded-xl border">
                                        <h4 className="font-bold text-xs text-slate-500 mb-2">店舗イベントマスタ</h4>
                                        <div className="flex gap-2">
                                            <input type="text" value={newStoreEventName} onChange={e => setNewStoreEventName(e.target.value)} className="flex-1 p-2 text-sm rounded border" placeholder="イベント名"/>
                                            <button onClick={addStoreEvent} className="bg-slate-700 text-white px-4 rounded text-xs font-bold">追加</button>
                                        </div>
                                        <div className="flex gap-2 mt-2 flex-wrap">
                                            {storeEventTypes.map(e => <span key={e.id} className={`${e.color} px-2 py-1 rounded text-[10px]`}>{e.name}</span>)}
                                        </div>
                                    </div>
                                    <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                                        <h4 className="font-bold text-xs text-indigo-500 mb-2">スタッフ行事マスタ (会議・研修など)</h4>
                                        <div className="flex gap-2">
                                            <input type="text" value={newStaffEventName} onChange={e => setNewStaffEventName(e.target.value)} className="flex-1 p-2 text-sm rounded border" placeholder="行事名"/>
                                            <button onClick={addStaffEvent} className="bg-indigo-600 text-white px-4 rounded text-xs font-bold">追加</button>
                                        </div>
                                        <div className="flex gap-2 mt-2 flex-wrap">
                                            {staffEventTypes.map(e => <span key={e.id} className={`${e.color} px-2 py-1 rounded text-[10px]`}>{e.name}</span>)}
                                        </div>
                                    </div>
                                </div>
                                <div className="overflow-x-auto rounded-xl border shadow-xl bg-white">
                                    <table className="w-full text-[10px] border-collapse">
                                        <thead className="bg-slate-50 border-b">
                                            <tr><th className="p-3 border-r w-40 sticky left-0 bg-slate-50 z-10 font-bold">スタッフ / 日付</th>{dateList.map(d => <th key={d} className={`p-1 border-r text-center min-w-[35px] ${isWeekend(d) ? 'bg-orange-50 text-orange-600' : ''}`}>{d}<br/>{getWeekDay(d)}</th>)}</tr>
                                            <tr className="bg-white"><th className="p-3 border-r sticky left-0 bg-white z-10 font-bold text-red-600">店舗イベント (クリック切替)</th>{dateList.map(d => {
                                                const ev = storeEventTypes.find(e => e.id === dailyStoreEvents[getDateKey(d)]);
                                                return <td key={d} onClick={() => toggleDailyStoreEvent(d)} className={`border-r p-2 cursor-pointer text-center hover:bg-red-50 ${ev ? ev.color + ' font-bold' : ''}`}>{ev ? 'EV' : ''}</td>;
                                            })}</tr>
                                        </thead>
                                        <tbody>
                                            {staffList.map(s => (
                                                <tr key={s.id} className="border-t hover:bg-slate-50">
                                                    <td className="p-3 border-r sticky left-0 bg-white z-10 font-bold">
                                                        {s.name} <br/><span className="text-[8px] opacity-50">{ROLES[s.role.toUpperCase()]?.label}</span>
                                                    </td>
                                                    {dateList.map(d => {
                                                        const req = requests[`${s.id}_${getDateKey(d)}`];
                                                        const sEv = staffEventTypes.find(e => e.id === req);
                                                        let content = "-"; let bg = "";
                                                        if (req === 'off') { content = "希"; bg = "bg-slate-700 text-white"; }
                                                        else if (req === 'paid') { content = "有"; bg = "bg-pink-400 text-white"; }
                                                        else if (sEv) { content = sEv.name.substring(0,1); bg = sEv.color; }
                                                        else if (['help_guest','event'].includes(s.role) && (req === 'guest_in' || req === 'event_in')) { content = "出"; bg = "bg-teal-500 text-white"; }
                                                        return <td key={d} onClick={() => handleRequestChange(s.id, d, s.role)} className={`border-r text-center p-2 cursor-pointer transition-all ${bg}`}>{content}</td>;
                                                    })}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* 5. Result */}
                        {activeTab === 'result' && (
                            <div className="space-y-6 animate-fadeIn">
                                <div className="flex justify-between items-center bg-white p-4 rounded-xl border">
                                    <button onClick={generateShift} className="bg-blue-600 hover:bg-blue-700 text-white px-10 py-4 rounded-xl font-bold shadow-xl flex items-center gap-2 transform active:scale-95 transition-all"><Icon name="RefreshCw"/> シフト作成実行</button>
                                    <div className="flex gap-2">
                                        <button onClick={handleExcelExport} className="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-4 rounded-xl font-bold shadow-lg flex items-center gap-2"><Icon name="FileSpreadsheet"/> EXCEL出力</button>
                                    </div>
                                </div>
                                {schedule && (
                                    <div className="overflow-x-auto rounded-2xl border border-slate-200 shadow-2xl bg-white">
                                        <table className="w-full text-[10px] border-collapse">
                                            <thead className="bg-slate-800 text-white">
                                                <tr><th className="p-4 border-r sticky left-0 bg-slate-800 z-10 w-32 shadow-lg">名前</th>{dateList.map(d => <th key={d} className={`p-2 border-r text-center min-w-[40px] ${isWeekend(d) ? 'text-orange-300' : ''}`}>{d}<br/><span className="text-[8px] font-normal">{getWeekDay(d)}</span></th>)}<th className="p-2 text-center bg-slate-900 w-16">休日</th></tr>
                                            </thead>
                                            <tbody>
                                                {staffList.map(s => {
                                                    let offCount = 0;
                                                    dateList.forEach(d => { if(['公休','希望','有給','定休'].includes(schedule[`${s.id}_${getDateKey(d)}`])) offCount++; });
                                                    return (
                                                        <tr key={s.id} className="border-b hover:bg-blue-50">
                                                            <td className="p-3 border-r sticky left-0 bg-white z-10 font-bold">{s.name}</td>
                                                            {dateList.map(d => {
                                                                const val = schedule[`${s.id}_${getDateKey(d)}`];
                                                                let cellClass = "p-2 border-r text-center ";
                                                                if (val === '早') cellClass += "text-blue-600 font-bold bg-blue-50";
                                                                else if (val === '遅') cellClass += "text-orange-600 font-bold bg-orange-50";
                                                                else if (val === 'フル') cellClass += "text-purple-600 font-bold bg-purple-50";
                                                                else if (['公休','希望','有給','定休'].includes(val)) cellClass += "text-slate-300 bg-slate-50";
                                                                else if (val && val !== '-') cellClass += "bg-indigo-50 text-indigo-800 font-bold";
                                                                return <td key={d} className={cellClass}>{val}</td>;
                                                            })}
                                                            <td className={`p-2 text-center font-bold ${offCount !== FIXED_OFF_DAYS && !['help_guest','event'].includes(s.role) ? 'text-red-500 bg-red-50' : 'text-green-600 bg-green-50'}`}>{offCount}</td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
