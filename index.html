import React, { useState, useEffect, useRef } from 'react';
import { 
  Calendar, Users, Settings, CheckCircle, 
  Trash2, RefreshCw, User, Star, 
  Download, Truck, Flag, LogIn, FileSpreadsheet,
  Upload, Briefcase
} from 'lucide-react';

// --- 定数・初期設定 ---

const ROLES = {
  MANAGER: { id: 'manager', label: '店長', color: 'bg-purple-100 text-purple-800', hexBg: '#f3e8ff', hexText: '#6b21a8', icon: <Star size={14} /> },
  VICE_MANAGER: { id: 'vice_manager', label: '副店長', color: 'bg-purple-50 text-purple-700', hexBg: '#faf5ff', hexText: '#7e22ce', icon: <Star size={12} /> },
  CREW: { id: 'crew', label: 'クルー', color: 'bg-blue-100 text-blue-800', hexBg: '#dbeafe', hexText: '#1e40af', icon: <User size={14} /> },
  PART_TIME: { id: 'part_time', label: 'バイト', color: 'bg-green-100 text-green-800', hexBg: '#dcfce7', hexText: '#166534', icon: <User size={14} /> },
  DISPATCH: { id: 'dispatch', label: '派遣', color: 'bg-orange-100 text-orange-800', hexBg: '#ffedd5', hexText: '#9a3412', icon: <Briefcase size={14} /> },
  HELP_GUEST: { id: 'help_guest', label: 'ヘルプ(受入)', color: 'bg-teal-100 text-teal-800', hexBg: '#ccfbf1', hexText: '#115e59', icon: <LogIn size={14} /> },
  EVENT: { id: 'event', label: 'イベント専属', color: 'bg-red-100 text-red-800', hexBg: '#fee2e2', hexText: '#991b1b', icon: <Star size={14} /> },
};

const WEEKDAYS = ['日', '月', '火', '水', '木', '金', '土'];

const HOLIDAYS_2025 = [
  '2025-01-01', '2025-01-13', '2025-02-11', '2025-02-23', '2025-02-24',
  '2025-03-20', '2025-04-29', '2025-05-03', '2025-05-04', '2025-05-05',
  '2025-05-06', '2025-07-21', '2025-08-11', '2025-09-15', '2025-09-23',
  '2025-10-13', '2025-11-03', '2025-11-23', '2025-11-24'
];

const DEFAULT_STORE_EVENT_TYPES = [
  { id: 'sevt_default', name: 'イベント', color: 'bg-red-500 text-white', hexBg:'#ef4444', hexText:'#ffffff', requiredAdd: 0 } 
];

const DEFAULT_STAFF_EVENT_TYPES = [
  { id: 'se_1', name: '会議', color: 'bg-indigo-200 text-indigo-800', hexBg: '#c7d2fe', hexText: '#3730a3' },
  { id: 'se_2', name: '巡回', color: 'bg-emerald-200 text-emerald-800', hexBg: '#a7f3d0', hexText: '#065f46' },
];

const FIXED_OFF_DAYS = 10; 
const MAX_CONSECUTIVE_WORK = 5; 

// --- 独立したコンポーネント ---
const TabButton = ({ id, label, icon: Icon, isActive, onClick }) => (
  <button
    onClick={() => onClick(id)}
    className={`flex items-center gap-2 px-3 py-3 border-b-2 text-sm whitespace-nowrap transition-colors ${
      isActive ? 'border-blue-600 text-blue-600 bg-blue-50 font-bold' : 'border-transparent text-gray-500 hover:text-gray-700'
    }`}
  >
    <Icon size={16} />{label}
  </button>
);

export default function ShiftMaker() {
  const [activeTab, setActiveTab] = useState('settings'); 
  
  // 1. 基本設定 
  const [storeName, setStoreName] = useState('');
  const [year, setYear] = useState(2025);
  const [month, setMonth] = useState(5);
  const [reqWeekday, setReqWeekday] = useState(2);
  const [reqWeekend, setReqWeekend] = useState(3);
  const [reqEvent, setReqEvent] = useState(4);
  const [shiftMode, setShiftMode] = useState('complex');
  const [closedWeekDays, setClosedWeekDays] = useState([]); 
  const [specificClosedDays, setSpecificClosedDays] = useState([]); 

  // 2. スタッフデータ
  const [staffList, setStaffList] = useState([
    { id: 1, name: '佐藤一郎', role: 'manager' },
    { id: 2, name: '鈴木花子', role: 'vice_manager' },
    { id: 3, name: '田中次郎', role: 'crew' },
    { id: 4, name: '高橋美咲', role: 'part_time' },
    { id: 5, name: 'イベント担当', role: 'event' },
    { id: 99, name: '新宿店よりヘルプ', role: 'help_guest' },
  ]);
  const [newStaffName, setNewStaffName] = useState('');
  const [newStaffRole, setNewStaffRole] = useState('crew');

  // 3. ヘルプ設定
  const [helpStores, setHelpStores] = useState([]); 
  const [newHelpStore, setNewHelpStore] = useState('');

  // 4. イベント・行事マスタ
  const [storeEventTypes, setStoreEventTypes] = useState(DEFAULT_STORE_EVENT_TYPES);
  const [newStoreEventName, setNewStoreEventName] = useState('');
  const [staffEventTypes, setStaffEventTypes] = useState(DEFAULT_STAFF_EVENT_TYPES);
  const [newStaffEventName, setNewStaffEventName] = useState('');

  // 5. 日別・個別設定
  const [dailyStoreEvents, setDailyStoreEvents] = useState({});
  const [requests, setRequests] = useState({});
  const [helpAssignments, setHelpAssignments] = useState({});

  // 6. 生成結果
  const [schedule, setSchedule] = useState(null);
  const [generationLog, setGenerationLog] = useState([]);

  const fileInputRef = useRef(null);

  // --- Persistence ---
  const STORAGE_KEY = 'shift_maker_pro_data_v24';

  const saveToLocal = () => {
    const data = getExportData();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); 
  };

  const getExportData = () => ({
    storeName, year, month,
    reqWeekday, reqWeekend, reqEvent, shiftMode,
    closedWeekDays, specificClosedDays,
    staffList, helpStores,
    storeEventTypes, staffEventTypes,
    dailyStoreEvents, requests, helpAssignments 
  });

  const handleExportFile = () => {
    const data = getExportData();
    const jsonString = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `shift_settings_${storeName || 'config'}_${year}${month}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const handleImportFile = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const parsed = JSON.parse(e.target.result);
        loadData(parsed);
        alert('設定ファイルを読み込みました');
      } catch (err) {
        alert('ファイルの読み込みに失敗しました');
      }
    };
    reader.readAsText(file);
  };

  const loadData = (parsed) => {
    if (parsed.storeName !== undefined) setStoreName(parsed.storeName);
    if (parsed.year !== undefined) setYear(parsed.year);
    if (parsed.month !== undefined) setMonth(parsed.month);
    if (parsed.reqWeekday !== undefined) setReqWeekday(parsed.reqWeekday);
    if (parsed.reqWeekend !== undefined) setReqWeekend(parsed.reqWeekend);
    if (parsed.reqEvent !== undefined) setReqEvent(parsed.reqEvent);
    if (parsed.shiftMode !== undefined) setShiftMode(parsed.shiftMode);
    if (parsed.closedWeekDays) setClosedWeekDays(parsed.closedWeekDays);
    if (parsed.specificClosedDays) setSpecificClosedDays(parsed.specificClosedDays);
    if (parsed.staffList) setStaffList(parsed.staffList);
    if (parsed.helpStores) setHelpStores(parsed.helpStores);
    if (parsed.storeEventTypes) setStoreEventTypes(parsed.storeEventTypes);
    if (parsed.staffEventTypes) setStaffEventTypes(parsed.staffEventTypes);
    if (parsed.dailyStoreEvents) setDailyStoreEvents(parsed.dailyStoreEvents);
    if (parsed.requests) setRequests(parsed.requests);
    if (parsed.helpAssignments) setHelpAssignments(parsed.helpAssignments);
  };

  useEffect(() => {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      try {
        loadData(JSON.parse(saved));
      } catch (e) { console.error("Load Error", e); }
    } else {
      setYear(new Date().getFullYear());
    }
  }, []);

  // --- Helpers ---
  const getDaysInMonth = (y, m) => new Date(y, m, 0).getDate();
  const daysInMonth = getDaysInMonth(year, month);
  const dateList = Array.from({ length: daysInMonth }, (_, i) => i + 1);
  const getDateKey = (d) => `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
  
  const getWeekDayIndex = (d) => new Date(year, month - 1, d).getDay();
  const getWeekDay = (d) => WEEKDAYS[getWeekDayIndex(d)];
  const isWeekend = (d) => { const w = getWeekDayIndex(d); return w === 0 || w === 6; };
  const isHoliday = (d) => HOLIDAYS_2025.includes(getDateKey(d));
  
  const isClosed = (d) => {
    const dateKey = getDateKey(d);
    if (specificClosedDays.includes(dateKey)) return true;
    return closedWeekDays.includes(getWeekDayIndex(d));
  };

  const isEventDay = (d) => {
    const key = getDateKey(d);
    const evtId = dailyStoreEvents[key];
    if (!evtId) return false;
    const evtDef = storeEventTypes.find(e => e.id === evtId);
    return !!evtDef; 
  };

  const getRequiredNum = (d) => {
    if (isEventDay(d)) return reqEvent;
    if (isWeekend(d) || isHoliday(d)) return reqWeekend;
    return reqWeekday;
  };
  
  // --- Handlers ---
  const addStaff = () => {
    if (!newStaffName) return;
    const newId = staffList.length > 0 ? Math.max(...staffList.map(s => s.id)) + 1 : 1;
    setStaffList([...staffList, { id: newId, name: newStaffName, role: newStaffRole }]);
    setNewStaffName('');
  };
  const removeStaff = (id) => setStaffList(staffList.filter(s => s.id !== id));

  const addHelpStore = () => {
    if (newHelpStore && !helpStores.includes(newHelpStore)) setHelpStores([...helpStores, newHelpStore]);
    setNewHelpStore('');
  };
  const removeHelpStore = (n) => setHelpStores(helpStores.filter(s => s !== n));

  const toggleClosedWeekDay = (dayIndex) => {
    if (closedWeekDays.includes(dayIndex)) setClosedWeekDays(closedWeekDays.filter(d => d !== dayIndex));
    else setClosedWeekDays([...closedWeekDays, dayIndex]);
  };
  const toggleSpecificClosedDay = (d) => {
    const key = getDateKey(d);
    if (specificClosedDays.includes(key)) setSpecificClosedDays(specificClosedDays.filter(k => k !== key));
    else setSpecificClosedDays([...specificClosedDays, key]);
  };

  const addStoreEventType = () => {
    if (!newStoreEventName) return;
    setStoreEventTypes([...storeEventTypes, { id: `sevt_${Date.now()}`, name: newStoreEventName, color: 'bg-gray-700 text-white', hexBg:'#374151', hexText:'#fff', requiredAdd: 0 }]);
    setNewStoreEventName('');
  };
  const removeStoreEventType = (id) => setStoreEventTypes(storeEventTypes.filter(e => e.id !== id));

  const addStaffEventType = () => {
    if (!newStaffEventName) return;
    setStaffEventTypes([...staffEventTypes, { id: `stevt_${Date.now()}`, name: newStaffEventName, color: 'bg-cyan-200 text-cyan-800', hexBg:'#a5f3fc', hexText:'#155e75' }]);
    setNewStaffEventName('');
  };
  const removeStaffEventType = (id) => setStaffEventTypes(staffEventTypes.filter(e => e.id !== id));

  const toggleDailyStoreEvent = (d) => {
    const key = getDateKey(d);
    const currentId = dailyStoreEvents[key];
    if (!currentId) {
      if (storeEventTypes.length > 0) setDailyStoreEvents({ ...dailyStoreEvents, [key]: storeEventTypes[0].id });
    } else {
      const idx = storeEventTypes.findIndex(e => e.id === currentId);
      if (idx >= 0 && idx < storeEventTypes.length - 1) {
        setDailyStoreEvents({ ...dailyStoreEvents, [key]: storeEventTypes[idx + 1].id });
      } else {
        const newEvs = { ...dailyStoreEvents };
        delete newEvs[key];
        setDailyStoreEvents(newEvs);
      }
    }
  };

  const handleRequestChange = (staffId, d, role) => {
    const key = `${staffId}_${getDateKey(d)}`;
    const current = requests[key];
    
    if (role === 'help_guest' || role === 'event') {
      const mark = role === 'event' ? 'event_in' : 'guest_in';
      if (current === mark) {
        const n = { ...requests }; delete n[key]; setRequests(n);
      } else {
        setRequests({ ...requests, [key]: mark });
      }
      return;
    }

    if (!current) setRequests({ ...requests, [key]: 'off' });
    else if (current === 'off') setRequests({ ...requests, [key]: 'paid' });
    else if (current === 'paid') {
      if (staffEventTypes.length > 0) setRequests({ ...requests, [key]: staffEventTypes[0].id });
      else { const n = { ...requests }; delete n[key]; setRequests(n); }
    } else {
      const idx = staffEventTypes.findIndex(e => e.id === current);
      if (idx !== -1 && idx < staffEventTypes.length - 1) {
        setRequests({ ...requests, [key]: staffEventTypes[idx + 1].id });
      } else { 
        const n = { ...requests }; 
        delete n[key]; 
        setRequests(n); 
      }
    }
  };

  const toggleAllHelpDates = (staffId, role) => {
    const mark = role === 'event' ? 'event_in' : 'guest_in';
    const isAllSelected = dateList.every(d => requests[`${staffId}_${getDateKey(d)}`] === mark);
    let newRequests = { ...requests };
    dateList.forEach(d => {
      const key = `${staffId}_${getDateKey(d)}`;
      if (isAllSelected) delete newRequests[key];
      else newRequests[key] = mark;
    });
    setRequests(newRequests);
  };

  const handleHelpAssignment = (staffId, d, storeName) => {
    const key = `${staffId}_${getDateKey(d)}`;
    const newAssign = { ...helpAssignments };
    if (storeName === '') delete newAssign[key];
    else newAssign[key] = storeName;
    setHelpAssignments(newAssign);
  };


  // --- Logic: Shift Generation (Priority: Manager -> Required -> Others) ---
  const generateShift = () => {
    let newSchedule = {};
    let logs = [];
    
    const workableDays = dateList.filter(d => !isClosed(d));
    const workableDaysCount = workableDays.length;
    
    // 店長・副店長の存在確認
    const managerIds = staffList.filter(s => s.role === 'manager').map(s => s.id);
    const viceManagerIds = staffList.filter(s => s.role === 'vice_manager').map(s => s.id);
    const hasResponsible = managerIds.length > 0 || viceManagerIds.length > 0;

    // 1. スタッフ初期化 (チケット計算: 公休10日目標)
    const staffStats = staffList.map(s => {
      let isFullTime = true; 
      if (s.role === 'help_guest' || s.role === 'event') {
        const mark = s.role === 'event' ? 'event_in' : 'guest_in';
        const selectedCount = dateList.filter(d => requests[`${s.id}_${getDateKey(d)}`] === mark).length;
        if (selectedCount < workableDaysCount - 2) { 
          isFullTime = false;
        }
      }

      let tokens = 0;
      if (isFullTime) {
        tokens = daysInMonth - FIXED_OFF_DAYS;
      }

      return { 
        ...s, 
        isFullTime, 
        tokens, 
        offCount: 0, 
        consecutiveWork: 0 
      };
    });

    // 2. 確定ステータス埋め込み
    for (let d = 1; d <= daysInMonth; d++) {
      const dateKey = getDateKey(d);
      const isDayClosed = isClosed(d);

      staffStats.forEach(staff => {
        const reqKey = `${staff.id}_${dateKey}`;
        const reqType = requests[reqKey];
        const helpDest = helpAssignments[reqKey];
        let status = null;

        if (isDayClosed) {
          status = '定休';
        } else if (!staff.isFullTime) {
          const mark = staff.role === 'event' ? 'event_in' : 'guest_in';
          if (reqType !== mark) status = '-';
        } else if (helpDest) {
          status = helpDest;
          staff.tokens--;
        } else if (reqType === 'off') {
          status = '希望';
          staff.tokens--; 
        } else if (reqType === 'paid') {
          status = '有給';
          staff.tokens--;
        } else {
          const sEvent = staffEventTypes.find(e => e.id === reqType);
          if (sEvent) {
            status = sEvent.name;
            staff.tokens--;
          }
        }

        if (status) {
          newSchedule[reqKey] = status;
          // 公休・定休・希望休を「休み」としてカウント
          if (['定休', '公休', '希望'].includes(status)) staff.offCount++;
        }
      });
    }

    // 3. スポットリクエスト仮登録
    dateList.forEach(d => {
      if (isClosed(d)) return;
      const dateKey = getDateKey(d);
      staffStats.forEach(staff => {
        if (!staff.isFullTime && !newSchedule[`${staff.id}_${dateKey}`]) {
           const mark = staff.role === 'event' ? 'event_in' : 'guest_in';
           if (requests[`${staff.id}_${dateKey}`] === mark) {
             // 出勤予定
           }
        }
      });
    });

    // 4. 日毎の勤務割り当て
    for (let d = 1; d <= daysInMonth; d++) {
      const dateKey = getDateKey(d);
      if (isClosed(d)) {
        staffStats.forEach(s => s.consecutiveWork = 0);
        continue;
      }

      const targetNum = getRequiredNum(d);
      const isEvt = isEventDay(d);

      // 候補者リスト
      let candidates = staffStats.filter(s => !newSchedule[`${s.id}_${dateKey}`]);

      // フィルタ (連勤、イベント、スポット)
      let assignedMembers = []; // この日の出勤確定者リスト

      // まず、スポット参加者(リクエスト有)を確定させる
      let spotMembers = [];
      
      // 候補者選抜
      candidates = candidates.filter(s => {
        // イベント専属
        if (s.role === 'event' && !isEvt) {
          newSchedule[`${s.id}_${dateKey}`] = '公休';
          s.offCount++;
          s.consecutiveWork = 0;
          return false;
        }
        // スポット参加者
        if (!s.isFullTime) {
          // ここに残っている＝リクエストあり
          spotMembers.push(s);
          return false; 
        }
        // 連勤チェック
        if (s.consecutiveWork >= MAX_CONSECUTIVE_WORK) {
          if (s.offCount >= FIXED_OFF_DAYS) {
             // 未来の公休を削って調整(公休10日固定のため)
             const futureOffDay = dateList.find(fd => {
                if (fd <= d) return false; 
                const fKey = `${s.id}_${getDateKey(fd)}`;
                return newSchedule[fKey] === '公休';
             });
             if (futureOffDay) {
                delete newSchedule[`${s.id}_${getDateKey(futureOffDay)}`];
                s.offCount--; 
             }
          }
          newSchedule[`${s.id}_${dateKey}`] = '公休';
          s.offCount++;
          s.consecutiveWork = 0;
          return false;
        }
        return true;
      });

      // スポットメンバーを確定リストへ
      assignedMembers = [...spotMembers];

      // --------------------------------------------------------------
      // ★重要ロジック: 責任者(店長/副店長)を最優先で1名確保する
      // --------------------------------------------------------------
      
      // 既に確定しているメンバー(スポット)に責任者がいるか？
      let responsibleAssigned = assignedMembers.some(s => s.role === 'manager' || s.role === 'vice_manager');

      if (!responsibleAssigned && hasResponsible) {
        // 候補者の中から責任者を探す
        // 優先順位: 店長 > 副店長 (ランダム要素もあり)
        let mgrCandidates = candidates.filter(s => s.role === 'manager' || s.role === 'vice_manager');
        
        if (mgrCandidates.length > 0) {
          // チケット(残り勤務日数)が多い順にソート + ランダム
          mgrCandidates.sort((a, b) => b.tokens - a.tokens + (Math.random() - 0.5));
          
          const selectedMgr = mgrCandidates[0];
          assignedMembers.push(selectedMgr);
          // 候補リストから削除
          candidates = candidates.filter(s => s.id !== selectedMgr.id);
          selectedMgr.tokens--;
          responsibleAssigned = true;
        }
      }

      // --------------------------------------------------------------
      // 残りの枠を埋める (必要人数 targetNum まで)
      // --------------------------------------------------------------
      
      // 残り枠
      let needed = Math.max(0, targetNum - assignedMembers.length);

      // ソート: チケットが多い順 (出勤すべき人)
      candidates.sort((a, b) => b.tokens - a.tokens + (Math.random() - 0.5));

      // 枠がある限り埋める
      while (needed > 0 && candidates.length > 0) {
        const picked = candidates.shift();
        assignedMembers.push(picked);
        picked.tokens--;
        needed--;
      }

      // --------------------------------------------------------------
      // 最低1人保証 (0人回避) & 1人の場合は責任者が望ましい
      // --------------------------------------------------------------
      if (assignedMembers.length === 0) {
        // 誰もいない！ -> 候補者がいれば誰でもいいから入れる (責任者ロジックで既に試行済みだが、念のため)
        if (candidates.length > 0) {
           // 再度責任者優先で探す
           candidates.sort((a, b) => {
             const aIsMgr = a.role === 'manager' || a.role === 'vice_manager';
             const bIsMgr = b.role === 'manager' || b.role === 'vice_manager';
             if (aIsMgr && !bIsMgr) return -1;
             if (!aIsMgr && bIsMgr) return 1;
             return 0;
           });
           const picked = candidates.shift();
           assignedMembers.push(picked);
           picked.tokens--;
        }
      }

      // --------------------------------------------------------------
      // 公休10日調整 (余剰人員の出勤)
      // 必要人数を超えても、公休消化のために出勤させる
      // --------------------------------------------------------------
      let leftovers = candidates; // まだ選ばれていない人
      leftovers.forEach(s => {
        if (s.offCount >= FIXED_OFF_DAYS) {
          // 既に休み十分 -> 出勤させる (人数オーバー許容)
          assignedMembers.push(s);
          s.tokens--;
        } else {
          // まだ休み足りない -> 公休
          newSchedule[`${s.id}_${dateKey}`] = '公休';
          s.offCount++;
          s.consecutiveWork = 0;
        }
      });

      // --------------------------------------------------------------
      // 確定 & ログ
      // --------------------------------------------------------------
      const finalCount = assignedMembers.length;
      assignedMembers.forEach((s, idx) => {
        const k = `${s.id}_${dateKey}`;
        let wType = 'フル';
        if (shiftMode === 'complex' && finalCount >= 2) {
           if (idx % 3 === 0) wType = '早';
           else if (idx % 3 === 1) wType = '遅';
        }
        newSchedule[k] = wType;
        s.consecutiveWork++;
      });

      // ログ用カウント
      let totalWorkers = 0;
      staffStats.forEach(s => {
        const v = newSchedule[`${s.id}_${dateKey}`];
        const isStaffEvt = staffEventTypes.some(ev => ev.name === v);
        if (v && !['定休','公休','希望','有給','-'].includes(v) && !isStaffEvt) totalWorkers++;
      });

      const dayStr = `${d}日(${getWeekDay(d)})`;
      if (totalWorkers === 0 && !isClosed(d)) {
         logs.push(`重大: ${dayStr} 出勤者が0名です。候補者が全員休み希望または連勤上限の可能性があります。`);
      } else if (totalWorkers < targetNum) {
         logs.push(`不足: ${dayStr} ${targetNum - totalWorkers}人不足 (現${totalWorkers}/目${targetNum})`);
      }
      
      // 責任者チェック (ログ出し)
      const finalHasMgr = staffStats.some(s => {
        const v = newSchedule[`${s.id}_${dateKey}`];
        return (s.role === 'manager' || s.role === 'vice_manager') && v && !['定休','公休','希望','有給','-'].includes(v);
      });
      if (totalWorkers > 0 && hasResponsible && !finalHasMgr) {
        logs.push(`注意: ${dayStr} 責任者(店長/副店長)が出勤していません。`);
      }
    }

    // 5. 最終整合性調整 (公休10日強制)
    staffStats.forEach(s => {
      if (!s.isFullTime) return;
      let diff = FIXED_OFF_DAYS - s.offCount;

      if (diff > 0) {
        // 公休不足 (働きすぎ) -> 出勤日を公休に変える
        let workDays = dateList.filter(d => {
           const v = newSchedule[`${s.id}_${getDateKey(d)}`];
           return v && !['定休','公休','希望','有給','-'].includes(v);
        });
        workDays.sort(() => Math.random() - 0.5);
        for (let i=0; i<diff; i++) {
          if (workDays[i]) {
            newSchedule[`${s.id}_${getDateKey(workDays[i])}`] = '公休';
            s.offCount++;
          }
        }
      } else if (diff < 0) {
         // 公休過多 (休みすぎ) -> 公休を出勤に変える
         const excess = Math.abs(diff);
         let offDays = dateList.filter(d => newSchedule[`${s.id}_${getDateKey(d)}`] === '公休');
         offDays.sort(() => Math.random() - 0.5);
         for (let i=0; i<excess; i++) {
            if (offDays[i]) {
               newSchedule[`${s.id}_${getDateKey(offDays[i])}`] = 'フル'; 
               s.offCount--;
            }
         }
      }
    });

    setSchedule(newSchedule);
    setGenerationLog(logs);
    setActiveTab('result');
    saveToLocal();
  };

  // --- Excel Export ---
  const handleExcelExport = () => {
    if (!schedule) return;

    const getStyle = (val) => {
      if (val === '早') return 'background-color:#eff6ff; color:#1e40af; font-weight:bold;';
      if (val === '遅') return 'background-color:#fff7ed; color:#9a3412; font-weight:bold;';
      if (val === 'フル') return 'background-color:#faf5ff; color:#6b21a8; font-weight:bold;';
      if (val === '希望') return 'background-color:#d1d5db; color:#374151; font-weight:bold;';
      if (val === '有給') return 'background-color:#fbcfe8; color:#be185d; font-weight:bold;';
      if (val === '公休') return 'background-color:#e0f2fe; color:#0369a1;';
      if (val === '定休') return 'background-color:#fecaca; color:#991b1b;';
      if (val === '-') return 'color:#d1d5db;';
      
      const sEvt = staffEventTypes.find(e => e.name === val);
      if (sEvt) return `background-color:${sEvt.hexBg}; color:${sEvt.hexText}; font-weight:bold;`;
      if (val && val.length > 0) return 'background-color:#fef9c3; color:#854d0e; font-weight:bold;'; 
      return '';
    };

    let tableHTML = `
      <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
      </head>
      <body>
      <table border="1" style="border-collapse: collapse; font-family: sans-serif;">
        <thead>
          <tr style="background-color: #1e293b; color: white;">
            <th style="padding: 5px;">スタッフ</th>
            <th style="padding: 5px;">役職</th>
    `;
    dateList.forEach(d => {
      const isC = isClosed(d);
      const isEvt = isEventDay(d);
      const isH = isHoliday(d);
      const isW = isWeekend(d);
      const bg = isC ? '#fee2e2' : (isEvt ? '#fca5a5' : (isH ? '#fce7f3' : (isW ? '#fff7ed' : '#f8fafc')));
      const color = isC ? '#991b1b' : (isEvt ? '#7f1d1d' : (isH ? '#be185d' : '#000000'));
      tableHTML += `<th style="background-color:${bg}; color:${color}; padding:5px; width:30px;">${d}<br/><span style="font-size:10px;">${getWeekDay(d)}</span></th>`;
    });
    tableHTML += `<th style="padding:5px;">休日計</th></tr></thead><tbody>`;

    staffList.forEach(staff => {
      const r = Object.values(ROLES).find(role => role.id === staff.role) || ROLES.CREW;
      let offCount = 0;
      dateList.forEach(d => {
          const v = schedule[`${staff.id}_${getDateKey(d)}`] || '';
          if (['定休', '公休', '希望'].includes(v)) offCount++;
      });

      tableHTML += `<tr>
        <td style="padding:5px; font-weight:bold;">${staff.name}</td>
        <td style="padding:5px; font-size:12px; background-color:${r.hexBg}; color:${r.hexText};">${r.label}</td>
      `;
      dateList.forEach(d => {
        const val = schedule[`${staff.id}_${getDateKey(d)}`] || '';
        const style = getStyle(val);
        tableHTML += `<td style="text-align:center; padding:5px; ${style}">${val}</td>`;
      });
      tableHTML += `<td style="text-align:center; padding:5px; font-weight:bold;">${offCount}</td>`;
      tableHTML += `</tr>`;
    });

    // 出勤計
    tableHTML += `<tr><td colspan="2" style="padding:5px; font-weight:bold; text-align:right; background-color:#f1f5f9;">出勤計</td>`;
    dateList.forEach(d => {
        const key = getDateKey(d);
        let workers = 0;
        staffList.forEach(s => {
            const v = schedule[`${s.id}_${key}`];
            const isStaffEvt = staffEventTypes.some(ev => ev.name === v);
            if (v && !['定休','公休','希望','有給','-'].includes(v) && !isStaffEvt) workers++;
        });
        tableHTML += `<td style="text-align:center; padding:5px; font-weight:bold; background-color:#f1f5f9;">${workers}</td>`;
    });
    tableHTML += `<td></td></tr></tbody></table></body></html>`;

    const blob = new Blob([tableHTML], { type: 'application/vnd.ms-excel' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${year}年${month}月${storeName || '店舗'}シフト.xls`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // --- Shift Mode Toggle Component ---
  const ModeToggle = () => (
    <div className="flex items-center gap-2 bg-white p-1 rounded border">
      <button onClick={() => setShiftMode('complex')} className={`px-3 py-1 text-xs rounded transition-colors ${shiftMode === 'complex' ? 'bg-blue-600 text-white' : 'text-gray-500'}`}>早/遅/フル</button>
      <button onClick={() => setShiftMode('simple')} className={`px-3 py-1 text-xs rounded transition-colors ${shiftMode === 'simple' ? 'bg-blue-600 text-white' : 'text-gray-500'}`}>フルのみ</button>
    </div>
  );

  return (
    <div className="min-h-screen bg-gray-50 p-2 md:p-6 font-sans text-gray-800">
      <div className="max-w-full mx-auto bg-white shadow-xl rounded-xl overflow-hidden min-h-[600px]">
        
        {/* Header */}
        <div className="bg-slate-800 p-4 text-white flex flex-col md:flex-row justify-between items-center gap-4">
          <div>
            <h1 className="text-xl md:text-2xl font-bold flex items-center gap-2">
              <RefreshCw /> Shift Maker Pro <span className="text-xs bg-blue-600 px-2 py-1 rounded">Ver 24.0</span>
            </h1>
            <p className="opacity-80 text-sm mt-1">{storeName || '店舗名未設定'} | {year}年{month}月 <span className="ml-3 px-2 py-0.5 bg-sky-600 text-white rounded text-xs font-semibold">責任者必須・公休10日</span></p>
          </div>
          <div className="flex gap-2 items-center">
            <button onClick={handleExportFile} className="bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded text-sm flex items-center gap-2" title="ファイルに書き出し">
              <Download size={16}/> 保存(ファイル)
            </button>
            <label className="bg-slate-600 hover:bg-slate-500 text-white px-3 py-2 rounded text-sm flex items-center gap-2 cursor-pointer" title="ファイルから読み込み">
              <Upload size={16}/> 復元
              <input type="file" accept=".json" ref={fileInputRef} onChange={handleImportFile} className="hidden" />
            </label>
          </div>
        </div>

        {/* Tabs */}
        <div className="flex border-b overflow-x-auto bg-white">
          <TabButton id="settings" label="基本設定" icon={Settings} isActive={activeTab === 'settings'} onClick={setActiveTab} />
          <TabButton id="staff" label="スタッフ" icon={Users} isActive={activeTab === 'staff'} onClick={setActiveTab} />
          <TabButton id="help" label="他店ヘルプ" icon={Truck} isActive={activeTab === 'help'} onClick={setActiveTab} />
          <TabButton id="conditions" label="予定・希望休" icon={Calendar} isActive={activeTab === 'conditions'} onClick={setActiveTab} />
          <TabButton id="result" label="シフト表" icon={CheckCircle} isActive={activeTab === 'result'} onClick={setActiveTab} />
        </div>

        <div className="p-4 md:p-6">
          {/* 1. Settings */}
          {activeTab === 'settings' && (
            <div className="flex flex-col md:flex-row gap-6">
              <div className="flex-1 space-y-6">
                <h2 className="text-lg font-bold border-l-4 border-slate-500 pl-3 mb-4">基本設定</h2>
                <div className="grid gap-4 bg-gray-50 p-4 rounded border">
                  <div><label className="block text-sm font-bold text-gray-700 mb-1">店舗名</label><input type="text" value={storeName} onChange={(e) => setStoreName(e.target.value)} className="w-full border rounded p-2" placeholder="例: 渋谷店"/></div>
                  <div className="flex gap-4">
                    <div className="w-1/2"><label className="block text-sm font-bold mb-1">年</label><input type="number" value={year} onChange={(e) => setYear(Number(e.target.value))} className="w-full border rounded p-2"/></div>
                    <div className="w-1/2"><label className="block text-sm font-bold mb-1">月</label><select value={month} onChange={(e) => setMonth(Number(e.target.value))} className="w-full border rounded p-2">{[...Array(12)].map((_, i) => <option key={i+1} value={i+1}>{i+1}月</option>)}</select></div>
                  </div>
                  <div><label className="block text-sm font-bold text-gray-700 mb-1">シフト種別</label><ModeToggle /></div>
                </div>
                <div className="bg-blue-50 p-4 rounded border border-blue-200">
                  <h3 className="font-bold text-blue-800 text-sm mb-3 flex items-center gap-2"><Users size={16}/> 必要人数設定</h3>
                  <div className="grid grid-cols-3 gap-4 text-center">
                    <div><label className="block text-xs font-bold text-gray-600 mb-1">平日</label><input type="number" min="1" value={reqWeekday} onChange={(e) => setReqWeekday(Number(e.target.value))} className="w-full border rounded p-2 text-center"/></div>
                    <div><label className="block text-xs font-bold text-orange-600 mb-1">週末・祝日</label><input type="number" min="1" value={reqWeekend} onChange={(e) => setReqWeekend(Number(e.target.value))} className="w-full border rounded p-2 text-center font-bold text-orange-600 bg-orange-50"/></div>
                    <div><label className="block text-xs font-bold text-red-600 mb-1">イベント日</label><input type="number" min="1" value={reqEvent} onChange={(e) => setReqEvent(Number(e.target.value))} className="w-full border rounded p-2 text-center font-bold text-red-600 bg-red-50"/></div>
                  </div>
                </div>
                <div className="bg-red-50 p-4 rounded border border-red-100">
                  <h3 className="font-bold text-red-800 text-sm mb-2">曜日定休設定</h3>
                  <div className="flex gap-2 flex-wrap">{WEEKDAYS.map((day, i) => (<button key={i} onClick={() => toggleClosedWeekDay(i)} className={`w-10 h-10 rounded-full font-bold transition-colors ${closedWeekDays.includes(i) ? 'bg-red-500 text-white shadow-inner' : 'bg-white border text-gray-500 hover:bg-gray-100'}`}>{day}</button>))}</div>
                </div>
              </div>
              <div className="flex-1">
                 <h2 className="text-lg font-bold border-l-4 border-red-400 pl-3 mb-4">特定日の定休設定</h2>
                 <div className="bg-white p-4 border rounded shadow-sm"><div className="grid grid-cols-7 gap-1">{WEEKDAYS.map(d => <div key={d} className="text-center text-xs font-bold py-1 bg-gray-100">{d}</div>)}{dateList.map(d => { const isC = isClosed(d); return (<button key={d} onClick={() => toggleSpecificClosedDay(d)} className={`h-10 text-sm border rounded hover:bg-red-100 ${isC ? 'bg-red-500 text-white font-bold' : 'bg-white'}`}>{d}</button>); })}</div></div>
              </div>
            </div>
          )}

          {/* 2. Staff */}
          {activeTab === 'staff' && (
            <div className="space-y-4">
              <h2 className="text-lg font-bold border-l-4 border-slate-500 pl-3">スタッフ管理</h2>
              <div className="bg-blue-50 p-4 rounded border flex flex-wrap gap-2 items-end">
                <div className="flex-1 min-w-[150px]"><label className="text-xs font-bold text-gray-500">氏名</label><input type="text" value={newStaffName} onChange={(e) => setNewStaffName(e.target.value)} className="w-full border rounded p-2" placeholder="名前"/></div>
                <div className="w-40"><label className="text-xs font-bold text-gray-500">属性</label><select value={newStaffRole} onChange={(e) => setNewStaffRole(e.target.value)} className="w-full border rounded p-2">{Object.values(ROLES).map(r => <option key={r.id} value={r.id}>{r.label}</option>)}</select></div>
                <button onClick={addStaff} disabled={!newStaffName} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">追加</button>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                {staffList.map(s => {
                  const r = Object.values(ROLES).find(role => role.id === s.role) || ROLES.CREW;
                  return (<div key={s.id} className="flex justify-between items-center p-3 border rounded bg-white shadow-sm"><div className="flex items-center gap-3"><div className={`w-8 h-8 rounded-full flex items-center justify-center ${r.color}`}>{r.icon}</div><div><p className="font-bold text-sm">{s.name}</p><p className="text-xs text-gray-500">{r.label}</p></div></div><button onClick={() => removeStaff(s.id)} className="text-gray-300 hover:text-red-500"><Trash2 size={16}/></button></div>);
                })}
              </div>
            </div>
          )}

          {/* 3. Help */}
          {activeTab === 'help' && (
            <div className="space-y-6">
              <h2 className="text-lg font-bold border-l-4 border-slate-500 pl-3">他店ヘルプ派遣</h2>
              <div className="bg-yellow-50 p-4 rounded border border-yellow-200"><h3 className="text-sm font-bold text-yellow-800 mb-2">派遣先店舗登録</h3><div className="flex gap-2"><input type="text" value={newHelpStore} onChange={(e) => setNewHelpStore(e.target.value)} maxLength={4} className="border p-2 rounded" placeholder="店舗名"/><button onClick={addHelpStore} className="bg-yellow-600 text-white px-4 rounded">登録</button></div><div className="flex gap-2 mt-2 flex-wrap">{helpStores.map(s => (<span key={s} className="bg-white px-2 py-1 rounded text-xs border flex gap-1 items-center">{s} <button onClick={() => removeHelpStore(s)} className="text-red-400">×</button></span>))}</div></div>
              <div className="overflow-x-auto border rounded">
                <table className="w-full text-xs"><thead><tr><th className="sticky left-0 bg-gray-100 p-2 border-r z-10 w-32">スタッフ(派遣元)</th>{dateList.map(d => <th key={d} className={`min-w-[30px] border-r p-1 text-center ${isWeekend(d)?'bg-orange-50':''}`}>{d}</th>)}</tr></thead>
                  <tbody>{staffList.filter(s => s.role !== 'help_guest').map(s => (<tr key={s.id}><td className="sticky left-0 bg-white p-2 border-r font-medium">{s.name}</td>{dateList.map(d => { const key = `${s.id}_${getDateKey(d)}`; return (<td key={d} className="border-r p-0 h-8"><select value={helpAssignments[key]||''} onChange={(e)=>handleHelpAssignment(s.id, d, e.target.value)} className={`w-full h-full text-center border-none focus:ring-0 text-[10px] ${helpAssignments[key]?'bg-yellow-100 font-bold':''}`}><option value="">-</option>{helpStores.map(hs => <option key={hs} value={hs}>{hs}</option>)}</select></td>);})}</tr>))}</tbody>
                </table>
              </div>
            </div>
          )}

          {/* 4. Conditions */}
          {activeTab === 'conditions' && (
            <div className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="bg-gray-50 p-4 rounded border border-gray-200"><h3 className="text-sm font-bold text-gray-800 mb-2 flex gap-2 items-center"><Flag size={16}/> 店舗イベント</h3><div className="flex gap-2 mb-3"><input type="text" value={newStoreEventName} onChange={(e)=>setNewStoreEventName(e.target.value)} className="border p-2 rounded w-full" placeholder="例: お客様感謝デー"/><button onClick={addStoreEventType} className="bg-gray-700 text-white px-4 rounded whitespace-nowrap">追加</button></div><div className="flex gap-2 flex-wrap">{storeEventTypes.map(ev => (<div key={ev.id} className={`${ev.color} px-3 py-1 rounded-full text-xs flex items-center gap-2 shadow-sm`}>{ev.name}<button onClick={()=>removeStoreEventType(ev.id)} className="hover:text-red-300">×</button></div>))}</div></div>
                <div className="bg-indigo-50 p-4 rounded border border-indigo-200"><h3 className="text-sm font-bold text-indigo-800 mb-2 flex gap-2 items-center"><User size={16}/> スタッフ行事</h3><div className="flex gap-2 mb-3"><input type="text" value={newStaffEventName} onChange={(e)=>setNewStaffEventName(e.target.value)} className="border p-2 rounded w-full" placeholder="例: 研修"/><button onClick={addStaffEventType} className="bg-indigo-600 text-white px-4 rounded whitespace-nowrap">追加</button></div><div className="flex gap-2 flex-wrap">{staffEventTypes.map(ev => (<div key={ev.id} className={`${ev.color} px-3 py-1 rounded-full text-xs flex items-center gap-2 shadow-sm`}>{ev.name}<button onClick={()=>removeStaffEventType(ev.id)} className="hover:text-red-500">×</button></div>))}</div></div>
              </div>
              <div className="overflow-x-auto border rounded shadow-inner max-h-[500px]">
                <table className="min-w-max border-collapse text-xs">
                  <thead className="sticky top-0 z-20 shadow-sm">
                    <tr><th className="sticky left-0 bg-gray-100 p-2 border z-30 min-w-[140px]">日付 / 店舗設定</th>{dateList.map(d => { const isH = isHoliday(d); const isC = isClosed(d); const isW = isWeekend(d); const headerClass = isC ? 'bg-red-100 text-red-800' : (isH ? 'bg-pink-100 text-pink-800' : (isW ? 'bg-orange-50' : 'bg-white')); return (<th key={d} className={`p-1 border min-w-[40px] text-center ${headerClass}`}><div>{d}</div><div className="text-[9px]">{getWeekDay(d)}</div></th>);})}</tr>
                    <tr><th className="sticky left-0 bg-gray-200 p-2 border text-left z-30"><div className="font-bold text-xs">店舗イベント</div></th>{dateList.map(d => { const key = getDateKey(d); const evId = dailyStoreEvents[key]; const evDef = storeEventTypes.find(e => e.id === evId); return (<td key={d} onClick={() => toggleDailyStoreEvent(d)} className={`border text-center cursor-pointer hover:opacity-80 transition-colors h-8 ${evDef ? evDef.color : 'bg-white'}`}>{evDef && <span className="text-[9px] leading-tight block">{evDef.name.substring(0,3)}</span>}</td>);})}</tr>
                  </thead>
                  <tbody>
                    {staffList.map(staff => (
                      <tr key={staff.id}>
                        <td className="sticky left-0 z-10 bg-white p-2 border-r border-b flex flex-col justify-center">
                          <div className="flex justify-between items-center mb-1"><span className="font-bold text-sm">{staff.name}</span>{(staff.role === 'help_guest' || staff.role === 'event') && (<button onClick={() => toggleAllHelpDates(staff.id, staff.role)} className="text-xs bg-teal-100 text-teal-800 px-1 rounded hover:bg-teal-200 border border-teal-300" title="日付全選択/全解除">全</button>)}</div><span className={`text-[10px] px-1 rounded w-max ${ROLES[staff.role.toUpperCase()]?.color}`}>{ROLES[staff.role.toUpperCase()]?.label}</span>
                        </td>
                        {dateList.map(d => {
                          const key = `${staff.id}_${getDateKey(d)}`;
                          const req = requests[key];
                          const isGuestLike = (staff.role === 'help_guest' || staff.role === 'event');
                          let cellClass = "cursor-pointer hover:bg-gray-100";
                          let content = "-";
                          if (isClosed(d)) return <td key={d} className="border bg-red-50 text-red-300 text-center text-[10px]">休</td>;
                          if (isGuestLike) { const mark = staff.role === 'event' ? 'event_in' : 'guest_in'; const label = staff.role === 'event' ? '出勤' : '受入'; if (req === mark) { cellClass = "bg-teal-100 text-teal-800 font-bold border-teal-200"; content = label; } } else { if (req === 'off') { cellClass = "bg-gray-300 text-gray-700 font-bold"; content = "希"; } else if (req === 'paid') { cellClass = "bg-pink-300 text-pink-700 font-bold"; content = "有"; } else { const sEvent = staffEventTypes.find(e => e.id === req); if (sEvent) { cellClass = `${sEvent.color} font-bold`; content = sEvent.name.substring(0,2); } } }
                          return (<td key={d} className={`border text-center p-1 transition-colors ${cellClass}`} onClick={() => handleRequestChange(staff.id, d, staff.role)}>{content}</td>);
                        })}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* 5. Result */}
          {activeTab === 'result' && (
            <div className="space-y-4">
              <div className="flex flex-wrap justify-between items-center bg-gray-100 p-3 rounded-lg gap-3">
                <h2 className="text-lg font-bold text-gray-700 flex gap-2 items-center"><CheckCircle className="text-blue-600"/> シフト表</h2>
                <div className="flex gap-2">
                  <button onClick={generateShift} className="bg-blue-600 text-white px-4 py-2 rounded font-bold shadow hover:bg-blue-700 flex gap-2"><RefreshCw size={18}/> 作成実行</button>
                  {schedule && (<button onClick={handleExcelExport} className="bg-green-700 text-white px-4 py-2 rounded font-bold shadow hover:bg-green-800 flex gap-2"><FileSpreadsheet size={18}/> エクセル出力</button>)}
                </div>
              </div>
              {generationLog.length > 0 && (<div className="bg-amber-50 p-3 rounded text-xs text-amber-800 border border-amber-200 max-h-32 overflow-y-auto"><div className="font-bold mb-1">生成ログ:</div>{generationLog.map((l, i) => <div key={i}>・{l}</div>)}</div>)}
              {schedule && (
                <div className="overflow-x-auto shadow-lg rounded border">
                  <table className="min-w-max border-collapse text-xs bg-white">
                    <thead><tr><th className="sticky left-0 z-10 bg-gray-100 p-2 border min-w-[120px]">スタッフ</th>{dateList.map(d => { const key = getDateKey(d); const isEvt = isEventDay(d); const isC = isClosed(d); const isH = isHoliday(d); const isW = isWeekend(d); const headerColor = isC ? 'bg-red-100 text-red-800' : (isEvt ? 'bg-red-200 text-red-900' : (isH ? 'bg-pink-100 text-pink-800' : (isW ? 'bg-orange-50' : 'bg-gray-50'))); return (<th key={d} className={`p-1 border min-w-[35px] text-center ${headerColor}`}><div>{d}</div><div className="text-[8px] font-normal">{getWeekDay(d)}</div>{isEvt && <div className="text-[8px] font-bold">EVT</div>}</th>); })}<th className="bg-gray-800 text-white border px-1">休日計</th></tr></thead>
                    <tbody>
                      {staffList.map(staff => {
                        let counts = { 休日計:0 };
                        dateList.forEach(d => { const v = schedule[`${staff.id}_${getDateKey(d)}`]; if (['定休', '公休', '希望'].includes(v)) counts.休日計++; });
                        return (<tr key={staff.id} className="hover:bg-blue-50"><td className="sticky left-0 z-10 bg-white p-2 border font-medium text-gray-700 border-r">{staff.name}</td>{dateList.map(d => { const key = `${staff.id}_${getDateKey(d)}`; const val = schedule[key] || '-'; let style = "text-gray-400"; if (val === '早') { style = "text-blue-600 font-bold bg-blue-50"; } else if (val === '遅') { style = "text-orange-600 font-bold bg-orange-50"; } else if (val === 'フル') { style = "text-purple-600 font-bold bg-purple-50"; } else if (val === '希望') { style = "bg-gray-300 text-gray-700"; } else if (val === '有給') { style = "bg-pink-200 text-pink-700"; } else if (val === '公休') { style = "bg-sky-100 text-sky-600"; } else if (val === '定休') { style = "bg-red-100 text-red-600"; } else if (val === '-') { style = "text-gray-300"; } else { const sEvt = staffEventTypes.find(e => e.name === val); if (sEvt) style = `${sEvt.color} font-bold`; else if (val.length > 0) style = "bg-yellow-100 text-yellow-800 font-bold text-[9px]"; } return <td key={d} className={`border text-center p-1 ${style}`}>{val.length > 3 ? val.substring(0,2) : val}</td>; })}<td className={`border text-center font-bold ${counts.休日計 !== FIXED_OFF_DAYS && !(staff.role === 'help_guest' || staff.role === 'event') ? 'text-red-600 bg-red-100' : 'bg-green-100 text-green-700'}`}>{counts.休日計}</td></tr>);
                      })}
                      {/* Total Workers Check */}
                      <tr className="bg-slate-700 text-white font-bold text-[10px]">
                        <td className="sticky left-0 z-10 bg-slate-700 p-2 text-right">出勤計</td>
                        {dateList.map(d => {
                          if (isClosed(d)) return <td key={d} className="border-r bg-red-900 text-center">-</td>;
                          const key = getDateKey(d);
                          const targetNum = getRequiredNum(d);
                          let workers = 0;
                          staffList.forEach(s => { const v = schedule[`${s.id}_${key}`]; const isStaffEvt = staffEventTypes.some(ev => ev.name === v); if (v && !['定休','公休','希望','有給','-'].includes(v) && !isStaffEvt) workers++; });
                          const colorClass = workers < targetNum ? 'bg-red-600' : 'bg-slate-700';
                          return (<td key={d} className={`border-r text-center ${colorClass}`}>{workers}<span className="opacity-50">/{targetNum}</span></td>);
                        })}
                        <td></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
