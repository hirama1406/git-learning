<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Maker Pro Ver 24.4</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <style>
        body { font-family: sans-serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* 名前カラムの固定と横書き強制（Ver 24.4） */
        .sticky-name-col {
            position: sticky;
            left: 0;
            z-index: 20;
            background-color: white !important;
            border-right: 2px solid #e2e8f0;
            white-space: nowrap !important; /* 絶対に改行させない */
            min-width: 160px; /* 役職ラベルも含めて余裕を持つ */
            padding-left: 0.75rem !important;
            padding-right: 0.75rem !important;
        }
        th.sticky-name-col {
            background-color: #f1f5f9 !important;
            z-index: 30;
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- アイコン (SVG内蔵) ---
        const Icon = ({ name, size = 16, className = "" }) => {
            const paths = {
                Calendar: <g><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></g>,
                Users: <g><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></g>,
                Settings: <g><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></g>,
                CheckCircle: <g><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></g>,
                Trash2: <g><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></g>,
                RefreshCw: <g><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></g>,
                User: <g><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></g>,
                Star: <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>,
                Download: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></g>,
                Truck: <g><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></g>,
                Flag: <g><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></g>,
                LogIn: <g><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></g>,
                FileSpreadsheet: <g><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="16" y2="17"/></g>,
                Briefcase: <g><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></g>
            };
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {paths[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        // --- タブボタンコンポーネント ---
        const TabButton = ({ id, label, icon, isActive, onClick }) => (
            <button
                onClick={() => onClick(id)}
                className={`flex items-center gap-2 px-4 py-3 border-b-2 text-sm whitespace-nowrap transition-all ${
                isActive ? 'border-blue-600 text-blue-600 bg-blue-50 font-bold' : 'border-transparent text-gray-500 hover:text-gray-700'
                }`}
            >
                <Icon name={icon} size={16} />{label}
            </button>
        );

        const ROLES = {
            MANAGER: { id: 'manager', label: '店長', color: 'bg-purple-100 text-purple-800', hexBg: '#f3e8ff', hexText: '#6b21a8', icon: 'Star' },
            VICE_MANAGER: { id: 'vice_manager', label: '副店長', color: 'bg-purple-50 text-purple-700', hexBg: '#faf5ff', hexText: '#7e22ce', icon: 'Star' },
            CREW: { id: 'crew', label: 'クルー', color: 'bg-blue-100 text-blue-800', hexBg: '#dbeafe', hexText: '#1e40af', icon: 'User' },
            PART_TIME: { id: 'part_time', label: 'バイト', color: 'bg-green-100 text-green-800', hexBg: '#dcfce7', hexText: '#166534', icon: 'User' },
            DISPATCH: { id: 'dispatch', label: '派遣', color: 'bg-orange-100 text-orange-800', hexBg: '#ffedd5', hexText: '#9a3412', icon: 'Briefcase' },
            HELP_GUEST: { id: 'help_guest', label: 'ヘルプ(受入)', color: 'bg-teal-100 text-teal-800', hexBg: '#ccfbf1', hexText: '#115e59', icon: 'LogIn' },
            EVENT: { id: 'event', label: 'イベント専属', color: 'bg-red-100 text-red-800', hexBg: '#fee2e2', hexText: '#991b1b', icon: 'Star' },
        };

        const WEEKDAYS = ['日', '月', '火', '水', '木', '金', '土'];
        const HOLIDAYS_2025 = ['2025-01-01', '2025-01-13', '2025-02-11', '2025-02-23', '2025-02-24', '2025-03-20', '2025-04-29', '2025-05-03', '2025-05-04', '2025-05-05', '2025-05-06', '2025-07-21', '2025-08-11', '2025-09-15', '2025-09-23', '2025-10-13', '2025-11-03', '2025-11-23', '2025-11-24'];
        const FIXED_OFF_DAYS = 10; 
        const MAX_CONSECUTIVE_WORK = 5; 
        const STORAGE_KEY = 'shift_maker_pro_v24_complete_v4';

        function App() {
            const [activeTab, setActiveTab] = useState('settings');
            const [storeName, setStoreName] = useState('マイショップ');
            const [year, setYear] = useState(2025);
            const [month, setMonth] = useState(5);
            const [reqWeekday, setReqWeekday] = useState(2);
            const [reqWeekend, setReqWeekend] = useState(3);
            const [reqEvent, setReqEvent] = useState(4);
            const [shiftMode, setShiftMode] = useState('complex');
            const [closedWeekDays, setClosedWeekDays] = useState([]); 
            const [specificClosedDays, setSpecificClosedDays] = useState([]); 
            const [staffList, setStaffList] = useState([
                { id: 1, name: '佐藤一郎', role: 'manager' },
                { id: 2, name: '鈴木花子', role: 'vice_manager' },
                { id: 3, name: '田中次郎', role: 'crew' },
                { id: 4, name: '高橋美咲', role: 'part_time' },
                { id: 5, name: 'イベント担当', role: 'event' },
                { id: 99, name: '新宿店よりヘルプ', role: 'help_guest' },
            ]);
            const [newStaffName, setNewStaffName] = useState('');
            const [newStaffRole, setNewStaffRole] = useState('crew');
            const [helpStores, setHelpStores] = useState([]); 
            const [newHelpStore, setNewHelpStore] = useState('');
            const [storeEventTypes, setStoreEventTypes] = useState([{ id: 'sevt_default', name: 'イベント', color: 'bg-red-500 text-white', hexBg: '#ef4444' }]);
            const [newStoreEventName, setNewStoreEventName] = useState('');
            const [staffEventTypes, setStaffEventTypes] = useState([
                { id: 'se_1', name: '会議', color: 'bg-indigo-200 text-indigo-800' },
                { id: 'se_2', name: '研修', color: 'bg-emerald-200 text-emerald-800' },
            ]);
            const [newStaffEventName, setNewStaffEventName] = useState('');
            const [dailyStoreEvents, setDailyStoreEvents] = useState({});
            const [requests, setRequests] = useState({});
            const [helpAssignments, setHelpAssignments] = useState({});
            const [schedule, setSchedule] = useState(null);

            // ブラウザ保存
            useEffect(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    try {
                        const p = JSON.parse(saved);
                        if(p.storeName) setStoreName(p.storeName);
                        if(p.year) setYear(p.year); if(p.month) setMonth(p.month);
                        if(p.staffList) setStaffList(p.staffList);
                        if(p.requests) setRequests(p.requests);
                        if(p.dailyStoreEvents) setDailyStoreEvents(p.dailyStoreEvents);
                        if(p.helpStores) setHelpStores(p.helpStores);
                        if(p.helpAssignments) setHelpAssignments(p.helpAssignments);
                        if(p.closedWeekDays) setClosedWeekDays(p.closedWeekDays);
                        if(p.specificClosedDays) setSpecificClosedDays(p.specificClosedDays);
                    } catch (e) { console.error(e); }
                }
            }, []);

            const saveLocal = () => {
                const data = { storeName, year, month, reqWeekday, reqWeekend, reqEvent, shiftMode, closedWeekDays, specificClosedDays, staffList, helpStores, storeEventTypes, staffEventTypes, dailyStoreEvents, requests, helpAssignments };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                alert("ブラウザに保存しました。");
            };

            const daysInMonth = new Date(year, month, 0).getDate();
            const dateList = Array.from({ length: daysInMonth }, (_, i) => i + 1);
            const getDateKey = (d) => `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const getWeekDayIndex = (d) => new Date(year, month - 1, d).getDay();
            const getWeekDay = (d) => WEEKDAYS[getWeekDayIndex(d)];
            const isWeekend = (d) => [0, 6].includes(getWeekDayIndex(d));
            const isHoliday = (d) => HOLIDAYS_2025.includes(getDateKey(d));
            const isClosed = (d) => specificClosedDays.includes(getDateKey(d)) || closedWeekDays.includes(getWeekDayIndex(d));
            const isEventDay = (d) => !!dailyStoreEvents[getDateKey(d)];
            const getRequiredNum = (d) => isEventDay(d) ? reqEvent : (isWeekend(d) ? reqWeekend : reqWeekday);

            // シフト作成
            const generateShift = () => {
                let newSchedule = {};
                const stats = staffList.map(s => ({ ...s, tokens: !['help_guest', 'event'].includes(s.role) ? daysInMonth - FIXED_OFF_DAYS : 0, cons: 0 }));
                
                for (let d = 1; d <= daysInMonth; d++) {
                    const k = getDateKey(d);
                    if (isClosed(d)) { stats.forEach(s => s.cons = 0); continue; }
                    const target = getRequiredNum(d);
                    let assigned = 0;
                    let candidates = [...stats].sort((a, b) => b.tokens - a.tokens + (Math.random() - 0.5));
                    
                    candidates.forEach(s => {
                        const rk = `${s.id}_${k}`;
                        if (requests[rk] === 'off') { newSchedule[rk] = '希望'; s.cons = 0; }
                        else if (requests[rk] === 'paid') { newSchedule[rk] = '有給'; s.cons = 0; }
                        else if (assigned < target && s.cons < MAX_CONSECUTIVE_WORK) {
                            newSchedule[rk] = shiftMode === 'complex' ? (assigned % 2 === 0 ? '早' : '遅') : 'フル';
                            s.tokens--; s.cons++; assigned++;
                        } else {
                            newSchedule[rk] = '公休'; s.cons = 0;
                        }
                    });
                }
                setSchedule(newSchedule); setActiveTab('result'); saveLocal();
            };

            return (
                <div className="max-w-6xl mx-auto md:my-6 bg-white shadow-2xl rounded-2xl overflow-hidden min-h-[850px]">
                    {/* Header */}
                    <div className="bg-slate-800 p-5 text-white flex justify-between items-center shadow-lg">
                        <h1 className="text-xl font-bold flex items-center gap-2"><Icon name="RefreshCw" className="text-blue-400"/> Shift Maker Pro Ver 24.4</h1>
                        <button onClick={saveLocal} className="bg-blue-600 hover:bg-blue-500 px-5 py-2 rounded text-xs font-bold transition-all">ブラウザに保存</button>
                    </div>

                    {/* Navigation */}
                    <div className="flex border-b overflow-x-auto bg-white sticky top-0 z-30 shadow-sm">
                        <TabButton id="settings" label="基本設定" icon="Settings" isActive={activeTab === 'settings'} onClick={setActiveTab} />
                        <TabButton id="staff" label="スタッフ" icon="Users" isActive={activeTab === 'staff'} onClick={setActiveTab} />
                        <TabButton id="help" label="他店ヘルプ" icon="Truck" isActive={activeTab === 'help'} onClick={setActiveTab} />
                        <TabButton id="conditions" label="予定・希望休" icon="Calendar" isActive={activeTab === 'conditions'} onClick={setActiveTab} />
                        <TabButton id="result" label="シフト表" icon="CheckCircle" isActive={activeTab === 'result'} onClick={setActiveTab} />
                    </div>

                    <div className="p-6">
                        {/* 1. Basic Settings */}
                        {activeTab === 'settings' && (
                            <div className="animate-fadeIn grid md:grid-cols-2 gap-8">
                                <div className="space-y-6">
                                    <div className="bg-slate-50 p-5 rounded-2xl border shadow-sm">
                                        <h3 className="font-bold text-slate-700 mb-4 border-l-4 border-blue-500 pl-2 text-sm">基本情報</h3>
                                        <div className="space-y-4">
                                            <div><label className="text-xs font-bold text-slate-500">店舗名</label><input type="text" value={storeName} onChange={e => setStoreName(e.target.value)} className="w-full border p-2 rounded mt-1 outline-none focus:ring-2 focus:ring-blue-500"/></div>
                                            <div className="flex gap-4">
                                                <div className="flex-1"><label className="text-xs font-bold text-slate-500">年</label><input type="number" value={year} onChange={e => setYear(Number(e.target.value))} className="w-full border p-2 rounded mt-1"/></div>
                                                <div className="flex-1"><label className="text-xs font-bold text-slate-500">月</label><select value={month} onChange={e => setMonth(Number(e.target.value))} className="w-full border p-2 rounded mt-1">{[...Array(12)].map((_, i) => <option key={i+1} value={i+1}>{i+1}月</option>)}</select></div>
                                            </div>
                                            <div>
                                                <label className="text-xs font-bold text-slate-500 mb-1 block">シフト種別</label>
                                                <div className="flex bg-white p-1 rounded border gap-1">
                                                    <button onClick={() => setShiftMode('complex')} className={`flex-1 py-1 text-xs rounded transition-all ${shiftMode === 'complex' ? 'bg-blue-600 text-white font-bold' : 'text-slate-400'}`}>早/遅/フル</button>
                                                    <button onClick={() => setShiftMode('simple')} className={`flex-1 py-1 text-xs rounded transition-all ${shiftMode === 'simple' ? 'bg-blue-600 text-white font-bold' : 'text-slate-400'}`}>フルのみ</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-blue-50 p-5 rounded-2xl border border-blue-100 shadow-sm">
                                        <h3 className="font-bold text-blue-800 mb-4 flex items-center gap-2 text-sm"><Icon name="Users"/> 必要人数設定</h3>
                                        <div className="grid grid-cols-3 gap-3">
                                            <div className="text-center"><label className="text-[10px] font-bold">平日</label><input type="number" value={reqWeekday} onChange={e => setReqWeekday(Number(e.target.value))} className="w-full border p-2 rounded mt-1 text-center font-bold"/></div>
                                            <div className="text-center"><label className="text-[10px] font-bold text-orange-600">土日祝</label><input type="number" value={reqWeekend} onChange={e => setReqWeekend(Number(e.target.value))} className="w-full border p-2 rounded mt-1 text-center font-bold bg-orange-50"/></div>
                                            <div className="text-center"><label className="text-[10px] font-bold text-red-600">イベント</label><input type="number" value={reqEvent} onChange={e => setReqEvent(Number(e.target.value))} className="w-full border p-2 rounded mt-1 text-center font-bold bg-red-50"/></div>
                                        </div>
                                    </div>
                                </div>
                                <div className="space-y-6">
                                    <div className="bg-red-50 p-5 rounded-2xl border border-red-100 shadow-sm">
                                        <h3 className="font-bold text-red-800 mb-4 flex items-center gap-2 text-sm"><Icon name="Calendar"/> 曜日定休設定</h3>
                                        <div className="flex gap-2 flex-wrap">
                                            {WEEKDAYS.map((w, i) => (
                                                <button key={i} onClick={() => setClosedWeekDays(closedWeekDays.includes(i) ? closedWeekDays.filter(x => x!==i) : [...closedWeekDays, i])} className={`w-10 h-10 rounded-full font-bold transition-all border ${closedWeekDays.includes(i) ? 'bg-red-500 text-white border-red-600' : 'bg-white text-slate-400'}`}>{w}</button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="bg-white p-5 rounded-2xl border shadow-sm">
                                        <h3 className="font-bold text-slate-700 mb-4 text-sm">特定日の定休設定（カレンダー選択）</h3>
                                        <div className="grid grid-cols-7 gap-1">
                                            {WEEKDAYS.map(w => <div key={w} className="text-center text-[10px] font-bold py-1 bg-slate-100">{w}</div>)}
                                            {dateList.map(d => {
                                                const key = getDateKey(d);
                                                const closed = isClosed(d);
                                                return (
                                                    <button key={d} onClick={() => setSpecificClosedDays(specificClosedDays.includes(key) ? specificClosedDays.filter(k => k!==key) : [...specificClosedDays, key])} className={`h-10 text-xs border rounded transition-all ${closed ? 'bg-red-500 text-white font-bold border-red-600' : 'hover:bg-blue-50'}`}>{d}</button>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 2. Staff Management */}
                        {activeTab === 'staff' && (
                            <div className="animate-fadeIn space-y-6">
                                <div className="bg-slate-800 p-5 rounded-2xl flex flex-wrap gap-4 items-end shadow-xl">
                                    <div className="flex-1 min-w-[200px]"><label className="text-xs text-slate-400 font-bold">新規スタッフ氏名</label><input type="text" value={newStaffName} onChange={e => setNewStaffName(e.target.value)} className="w-full bg-slate-700 text-white p-3 rounded mt-1 border border-slate-600" placeholder="名前を入力"/></div>
                                    <div className="w-48"><label className="text-xs text-slate-400 font-bold">役職</label><select value={newStaffRole} onChange={e => setNewStaffRole(e.target.value)} className="w-full bg-slate-700 text-white p-3 rounded mt-1 border border-slate-600">{Object.values(ROLES).map(r => <option key={r.id} value={r.id}>{r.label}</option>)}</select></div>
                                    <button onClick={() => { if(newStaffName) { setStaffList([...staffList, {id: Date.now(), name: newStaffName, role: newStaffRole}]); setNewStaffName(''); } }} className="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-xl font-bold transition-all">追加</button>
                                </div>
                                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {staffList.map(s => {
                                        const r = ROLES[s.role.toUpperCase()] || ROLES.CREW;
                                        return (
                                            <div key={s.id} className="flex items-center justify-between p-4 bg-white border rounded-xl shadow-sm hover:shadow-md group">
                                                <div className="flex items-center gap-3">
                                                    <div className={`p-2 rounded-full ${r.color}`}><Icon name={r.icon} size={20}/></div>
                                                    <div><p className="font-bold">{s.name}</p><p className="text-[10px] text-slate-400 font-bold tracking-widest">{r.label}</p></div>
                                                </div>
                                                <button onClick={() => setStaffList(staffList.filter(x => x.id !== s.id))} className="text-slate-200 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"><Icon name="Trash2" size={18}/></button>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* 3. Help Tab */}
                        {activeTab === 'help' && (
                            <div className="animate-fadeIn space-y-6">
                                <div className="bg-teal-50 p-5 rounded-2xl border border-teal-100 shadow-sm">
                                    <h3 className="font-bold text-teal-900 mb-4 flex items-center gap-2 text-sm"><Icon name="Truck"/> 他店ヘルプ設定</h3>
                                    <div className="flex gap-2 mb-4">
                                        <input type="text" value={newHelpStore} onChange={e => setNewHelpStore(e.target.value)} className="border p-2 rounded flex-1" placeholder="派遣先店舗名"/>
                                        <button onClick={() => { if(newHelpStore) { setHelpStores([...helpStores, newHelpStore]); setNewHelpStore(''); } }} className="bg-teal-600 text-white px-4 py-2 rounded font-bold">登録</button>
                                    </div>
                                    <div className="flex gap-2 flex-wrap">
                                        {helpStores.map((s, i) => <span key={i} className="bg-white border text-teal-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-2">{s} <button onClick={() => setHelpStores(helpStores.filter(x => x!==s))} className="text-red-400">×</button></span>)}
                                    </div>
                                </div>
                                <div className="overflow-x-auto rounded-xl border">
                                    <table className="w-full text-[10px] border-collapse">
                                        <thead><tr className="bg-slate-100">
                                            <th className="sticky-name-col p-3 border-r">スタッフ(派遣元)</th>
                                            {dateList.map(d => <th key={d} className="p-1 border-r text-center min-w-[35px]">{d}</th>)}
                                        </tr></thead>
                                        <tbody>
                                            {staffList.filter(s => !['help_guest', 'event'].includes(s.role)).map(s => (
                                                <tr key={s.id} className="border-t">
                                                    <td className="sticky-name-col font-bold p-3 border-r bg-white">{s.name}</td>
                                                    {dateList.map(d => {
                                                        const key = `${s.id}_${getDateKey(d)}`;
                                                        return (
                                                            <td key={d} className="border-r p-0 h-10">
                                                                <select value={helpAssignments[key] || ''} onChange={e => setHelpAssignments({ ...helpAssignments, [key]: e.target.value })} className={`w-full h-full text-center border-none outline-none focus:ring-0 ${helpAssignments[key] ? 'bg-teal-100 font-bold' : 'bg-transparent text-slate-300'}`}>
                                                                    <option value="">-</option>
                                                                    {helpStores.map(h => <option key={h} value={h}>{h}</option>)}
                                                                </select>
                                                            </td>
                                                        );
                                                    })}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* 4. Conditions Tab */}
                        {activeTab === 'conditions' && (
                            <div className="animate-fadeIn space-y-6">
                                <div className="grid md:grid-cols-2 gap-4">
                                    <div className="bg-red-50 p-4 rounded-xl border border-red-100 shadow-sm">
                                        <h3 className="font-bold text-red-900 mb-2 flex items-center gap-2 text-sm"><Icon name="Flag"/> 店舗イベント登録</h3>
                                        <div className="flex gap-2">
                                            <input type="text" value={newStoreEventName} onChange={e => setNewStoreEventName(e.target.value)} className="border p-2 rounded flex-1" placeholder="感謝デーなど"/>
                                            <button onClick={() => { if(newStoreEventName) { setStoreEventTypes([...storeEventTypes, { id: `sevt_${Date.now()}`, name: newStoreEventName, color: 'bg-red-600 text-white' }]); setNewStoreEventName(''); } }} className="bg-red-600 text-white px-4 py-2 rounded font-bold">追加</button>
                                        </div>
                                    </div>
                                    <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 shadow-sm">
                                        <h3 className="font-bold text-indigo-900 mb-2 flex items-center gap-2 text-sm"><Icon name="Users"/> スタッフ行事登録</h3>
                                        <div className="flex gap-2">
                                            <input type="text" value={newStaffEventName} onChange={e => setNewStaffEventName(e.target.value)} className="border p-2 rounded flex-1" placeholder="会議・研修など"/>
                                            <button onClick={() => { if(newStaffEventName) { setStaffEventTypes([...staffEventTypes, { id: `stevt_${Date.now()}`, name: newStaffEventName, color: 'bg-indigo-600 text-white' }]); setNewStaffEventName(''); } }} className="bg-indigo-600 text-white px-4 py-2 rounded font-bold">追加</button>
                                        </div>
                                    </div>
                                </div>
                                <div className="overflow-x-auto rounded-xl border border-slate-200 shadow-2xl bg-white">
                                    <table className="w-full text-[11px] border-collapse">
                                        <thead className="sticky top-0 z-40 bg-slate-50 border-b">
                                            <tr>
                                                <th className="sticky-name-col font-bold bg-slate-100 text-slate-800">名前 / 日付</th>
                                                {dateList.map(d => <th key={d} className={`p-2 border-r text-center min-w-[40px] ${isWeekend(d) ? 'bg-orange-50 text-orange-600' : ''}`}>{d}<br/>{getWeekDay(d)}</th>)}
                                            </tr>
                                            <tr className="bg-red-50 border-b">
                                                <th className="sticky-name-col font-bold text-red-600 text-center">店舗イベント</th>
                                                {dateList.map(d => {
                                                    const key = getDateKey(d);
                                                    const isEvt = isEventDay(d);
                                                    return (
                                                        <td key={d} onClick={() => setDailyStoreEvents(isEvt ? (() => { const n = { ...dailyStoreEvents }; delete n[key]; return n; })() : { ...dailyStoreEvents, [key]: 'evt' })} 
                                                            className={`border-r p-2 cursor-pointer text-center font-bold hover:bg-red-100 transition-all ${isEvt ? 'bg-red-600 text-white' : 'text-red-200'}`}>{isEvt ? 'EV' : '・'}</td>
                                                    );
                                                })}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {staffList.map(s => {
                                                const rInfo = ROLES[s.role.toUpperCase()] || ROLES.CREW;
                                                return (
                                                    <tr key={s.id} className="border-b hover:bg-blue-50 transition-colors">
                                                        <td className="sticky-name-col font-bold p-3 border-r bg-white">
                                                            <div>{s.name}</div>
                                                            <div className={`text-[8px] font-bold inline-block px-1 rounded ${rInfo.color}`}>{rInfo.label}</div>
                                                        </td>
                                                        {dateList.map(d => {
                                                            const k = `${s.id}_${getDateKey(d)}`;
                                                            const req = requests[k];
                                                            const isGuest = s.role === 'help_guest' || s.role === 'event';
                                                            let content = "-"; let bg = "";
                                                            if (req === 'off') { content = "希"; bg = "bg-slate-600 text-white"; }
                                                            else if (req === 'paid') { content = "有"; bg = "bg-pink-400 text-white"; }
                                                            else if (isGuest && (req === 'event_in' || req === 'guest_in')) { content = "出"; bg = "bg-teal-500 text-white"; }
                                                            
                                                            return (
                                                                <td key={d} onClick={() => {
                                                                    const next = req === 'off' ? 'paid' : (req === 'paid' ? undefined : 'off');
                                                                    setRequests({ ...requests, [k]: isGuest ? (req ? undefined : (s.role === 'event' ? 'event_in' : 'guest_in')) : next });
                                                                }} className={`border-r text-center p-2 cursor-pointer select-none transition-all ${bg}`}>{content}</td>
                                                            );
                                                        })}
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* 5. Result Tab */}
                        {activeTab === 'result' && (
                            <div className="space-y-6 animate-fadeIn">
                                <div className="flex justify-between items-center bg-white p-4 rounded-xl border shadow-sm">
                                    <button onClick={generateShift} className="bg-blue-600 hover:bg-blue-700 text-white px-10 py-4 rounded-xl font-bold shadow-xl flex items-center gap-3 transform active:scale-95 transition-all"><Icon name="RefreshCw" size={20}/> シフト作成実行</button>
                                    <button onClick={() => {
                                        let html = `<table border="1"><thead><tr style="background:#333;color:white"><th>名前</th>${dateList.map(d=>`<th>${d}</th>`).join('')}</tr></thead><tbody>`;
                                        staffList.forEach(s => {
                                            html += `<tr><td style="font-weight:bold">${s.name}</td>${dateList.map(d => `<td>${schedule[`${s.id}_${getDateKey(d)}`] || ''}</td>`).join('')}</tr>`;
                                        });
                                        html += `</tbody></table>`;
                                        const link = document.createElement('a'); link.href = URL.createObjectURL(new Blob([html], { type: 'application/vnd.ms-excel' })); link.download = 'shift_maker_export.xls'; link.click();
                                    }} className="bg-emerald-600 text-white px-6 py-4 rounded-xl font-bold flex items-center gap-2 shadow-lg"><Icon name="FileSpreadsheet" size={20}/> EXCEL出力</button>
                                </div>
                                
                                {schedule && (
                                    <div className="overflow-x-auto rounded-xl border border-slate-200 shadow-2xl bg-white">
                                        <table className="w-full text-[11px] border-collapse">
                                            <thead className="bg-slate-800 text-white">
                                                <tr>
                                                    <th className="sticky-name-col font-bold bg-slate-800 text-white shadow-lg p-4 z-40">名前</th>
                                                    {dateList.map(d => <th key={d} className={`p-2 border-r text-center min-w-[45px] ${isWeekend(d) ? 'text-orange-300' : ''}`}>{d}<br/><span className="text-[9px] font-normal">{getWeekDay(d)}</span></th>)}
                                                    <th className="p-2 text-center bg-slate-900 sticky right-0 z-30">休日</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {staffList.map(s => {
                                                    let offCount = 0;
                                                    dateList.forEach(d => { if(['公休','希望','有給','定休'].includes(schedule[`${s.id}_${getDateKey(d)}`])) offCount++; });
                                                    return (
                                                        <tr key={s.id} className="border-b hover:bg-blue-50 transition-colors group">
                                                            <td className="sticky-name-col font-bold p-3 border-r bg-white z-20 shadow-sm group-hover:bg-blue-50 transition-colors">{s.name}</td>
                                                            {dateList.map(d => {
                                                                const val = schedule[`${s.id}_${getDateKey(d)}`];
                                                                let cellClass = "p-2 border-r text-center ";
                                                                if (val === '早') cellClass += "text-blue-600 font-bold bg-blue-50";
                                                                else if (val === '遅') cellClass += "text-orange-600 font-bold bg-orange-50";
                                                                else if (val === 'フル') cellClass += "text-purple-600 font-bold bg-purple-50";
                                                                else if (['公休','希望','有給','定休'].includes(val)) cellClass += "text-slate-200 bg-slate-50 font-normal";
                                                                return <td key={d} className={cellClass}>{val}</td>;
                                                            })}
                                                            <td className={`p-2 text-center font-bold sticky right-0 bg-white border-l z-20 shadow-lg ${offCount !== FIXED_OFF_DAYS && !['help_guest','event'].includes(s.role) ? 'text-red-500 underline bg-red-50' : 'text-green-600'}`}>{offCount}</td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
